<!DOCTYPE html>
<html lang="es">
<head>
ย ย <meta charset="UTF-8">
ย ย <meta name="viewport" content="width=device-width, initial-scale=1.0">
ย ย <title>El Taller del Mago: Selecciรณn de Ingredientes</title>
ย ยย
ย ย <style>
ย ย ย ย /* ======================================================================= */
ย ย ย ย /* VARIABLES Y ESTILOS BASE (Tema Oscuro Mรกgico) */
ย ย ย ย /* ======================================================================= */
ย ย ย ย :root {
ย ย ย ย ย ย --bg-color: #0d1117;
ย ย ย ย ย ย --text-color: #c9d1d9;
ย ย ย ย ย ย --accent-color: #58a6ff; /* Azul mรกgico */
ย ย ย ย ย ย --success-color: #238636;
ย ย ย ย ย ย --box-bg-color: #161b22; /* Fondo de las cajas mรกgicas */
ย ย ย ย ย ย --box-border-color: #30363d;
ย ย ย ย ย ย --vortex-color: rgba(88, 166, 255, 0.8);
ย ย ย ย ย ย --ingredient-lift: 50px; /* Distancia de levitaciรณn */
ย ย ย ย ย ย /* Nueva variable para la posiciรณn de la Galerรญa */
ย ย ย ย ย ย --gallery-offset-top: 200px;
ย ย ย ย }
ย ย ย ยย
ย ย ย ย body {
ย ย ย ย ย ย background-color: var(--bg-color);
ย ย ย ย ย ย color: var(--text-color);
ย ย ย ย ย ย font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
ย ย ย ย ย ย padding: 10px;
ย ย ย ย ย ย text-align: center;
ย ย ย ย ย ย font-size: 0.9em;
ย ย ย ย ย ย overflow-x: hidden;
ย ย ย ย ย ย position: relative;
ย ย ย ย }
ย ย ย ยย
ย ย ย ย h2 {
ย ย ย ย ย ย font-size: 1.6em;
ย ย ย ย ย ย color: var(--accent-color);
ย ย ย ย ย ย margin-bottom: 20px;
ย ย ย ย }

ย ย ย ย /* ------------------------------------------------------------------- */
ย ย ย ย /* CONTENEDOR DE LISTA INICIAL (Overlay Flotante/Lista de Compras) */
ย ย ย ย /* ------------------------------------------------------------------- */
ย ย ย ย #initial-selection-container {
ย ย ย ย ย ย background-color: #1f242b;
ย ย ย ย ย ย border: 1px solid var(--box-border-color);
ย ย ย ย ย ย border-radius: 8px;
ย ย ย ย ย ย padding: 15px;
ย ย ย ย ย ย /* Posicionamiento Fixed para Overlay */
ย ย ย ย ย ย position: fixed;ย
ย ย ย ย ย ย top: 50%;
ย ย ย ย ย ย left: 50%;
ย ย ย ย ย ย transform: translate(-50%, -50%) scale(0.8);ย
ย ย ย ย ย ย z-index: 1000;ย
ย ย ย ย ย ย max-width: 90%;ย
ย ย ย ย ย ย max-height: 90vh;
ย ย ย ย ย ย box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7);
ย ย ย ย ย ยย
ย ย ย ย ย ย /* Estado inicial Oculto */
ย ย ย ย ย ย opacity: 0;
ย ย ย ย ย ย pointer-events: none;
ย ย ย ย ย ย transition: opacity 0.3s ease-out, transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);ย
ย ย ย ย }

ย ย ย ย /* Estado Visible (Maximizado) */
ย ย ย ย #initial-selection-container:not(.minimized) {
ย ย ย ย ย ย opacity: 1;
ย ย ย ย ย ย pointer-events: all;
ย ย ย ย ย ย transform: translate(-50%, -50%) scale(1);
ย ย ย ย }

ย ย ย ย #initial-selection-list {
ย ย ย ย ย ย max-height: 400px;
ย ย ย ย ย ย overflow-y: auto;
ย ย ย ย ย ย display: grid;
ย ย ย ย ย ย grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
ย ย ย ย ย ย gap: 10px;
ย ย ย ย ย ย padding-top: 10px;
ย ย ย ย ย ย text-align: left;
ย ย ย ย }
ย ย ย ยย
ย ย ย ย .initial-item {
ย ย ย ย ย ย display: flex;
ย ย ย ย ย ย align-items: center;
ย ย ย ย ย ย gap: 5px;
ย ย ย ย ย ย padding: 5px;
ย ย ย ย ย ย border-bottom: 1px dashed #30363d;
ย ย ย ย }
ย ย ย ยย
ย ย ย ย .list-close-button {
ย ย ย ย ย ย padding: 8px 15px;
ย ย ย ย ย ย border: none;
ย ย ย ย ย ย border-radius: 4px;
ย ย ย ย ย ย font-weight: bold;
ย ย ย ย ย ย cursor: pointer;
ย ย ย ย ย ย margin-top: 10px;
ย ย ย ย ย ย background-color: #ffa500;ย
ย ย ย ย ย ย color: #161b22;
ย ย ย ย }

ย ย ย ย /* ------------------------------------------------------------------- */
ย ย ย ย /* GALERรA DE CAJAS MรGICAS (Simulando el Supermercado) */
ย ย ย ย /* ------------------------------------------------------------------- */

ย ย ย ย /* Contenedor que maneja el posicionamiento de las flechas */
ย ย ย ย #gallery-wrapper {
ย ย ย ย ย ย /* โญ๏ธ CAMBIO: Mover la galerรญa 200px hacia abajo */
ย ย ย ย ย ย margin-top: var(--gallery-offset-top);
ย ย ย ย ย ยย
ย ย ย ย ย ย display: flex;
ย ย ย ย ย ย align-items: center;
ย ย ย ย ย ย justify-content: center;
ย ย ย ย ย ย width: 100%;
ย ย ย ย ย ย margin-left: auto;
ย ย ย ย ย ย margin-right: auto;
ย ย ย ย ย ย position: relative;
ย ย ย ย }
ย ย ย ยย
ย ย ย ย /* Contenedor principal de las cajas: habilita el scroll horizontal */
ย ย ย ย #magic-boxes-gallery {
ย ย ย ย ย ย display: flex;
ย ย ย ย ย ย flex-wrap: nowrap;ย
ย ย ย ย ย ย overflow-x: scroll;ย
ย ย ย ย ย ย overflow-y: hidden;
ย ย ย ย ย ย scroll-behavior: smooth;ย
ย ย ย ย ย ย gap: 20px;
ย ย ย ย ย ย padding: 20px 0;
ย ย ย ย ย ย width: 90%;ย
ย ย ย ย ย ย -webkit-overflow-scrolling: touch;
ย ย ย ย }
ย ย ย ยย
ย ย ย ย /* Ocultar la barra de scroll nativa (Opcional, para estรฉtica) */
ย ย ย ย #magic-boxes-gallery::-webkit-scrollbar {
ย ย ย ย ย ย display: none;
ย ย ย ย }
ย ย ย ย #magic-boxes-gallery {
ย ย ย ย ย ย -ms-overflow-style: none; /* IE and Edge */
ย ย ย ย ย ย scrollbar-width: none; /* Firefox */
ย ย ย ย }
ย ย ย ยย
ย ย ย ย .magic-box {
ย ย ย ย ย ย width: 150px;
ย ย ย ย ย ย min-width: 150px;ย
ย ย ย ย ย ย height: 150px;
ย ย ย ย ย ย background-color: var(--box-bg-color);
ย ย ย ย ย ย border: 3px solid var(--box-border-color);
ย ย ย ย ย ย border-radius: 10px;
ย ย ย ย ย ย box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
ย ย ย ย ย ย position: relative;
ย ย ย ย ย ย padding: 10px;
ย ย ย ย ย ย display: flex;
ย ย ย ย ย ย flex-wrap: wrap;
ย ย ย ย ย ย justify-content: center;
ย ย ย ย ย ย align-items: center;
ย ย ย ย ย ย gap: 5px;
ย ย ย ย ย ย transition: border-color 0.3s;
ย ย ย ย }

ย ย ย ย .box-title {
ย ย ย ย ย ย position: absolute;
ย ย ย ย ย ย top: -15px;
ย ย ย ย ย ย background: var(--bg-color);
ย ย ย ย ย ย padding: 0 8px;
ย ย ย ย ย ย border-radius: 5px;
ย ย ย ย ย ย font-size: 0.8em;
ย ย ย ย ย ย color: #ffa500;
ย ย ย ย ย ย font-weight: bold;
ย ย ย ย }

ย ย ย ย .ing-slot {
ย ย ย ย ย ย width: 40px;
ย ย ย ย ย ย height: 40px;
ย ย ย ย ย ย display: flex;
ย ย ย ย ย ย justify-content: center;
ย ย ย ย ย ย align-items: center;
ย ย ย ย ย ย font-size: 1.5em;
ย ย ย ย ย ย cursor: pointer;
ย ย ย ย ย ย border-radius: 4px;
ย ย ย ย ย ย transition: background-color 0.2s;
ย ย ย ย }
ย ย ย ยย
ย ย ย ย .ing-slot:hover {
ย ย ย ย ย ย background-color: #30363d;
ย ย ย ย }
ย ย ย ยย
ย ย ย ย /* Flechas de Navegaciรณn */
ย ย ย ย .scroll-button {
ย ย ย ย ย ย position: absolute;
ย ย ย ย ย ย padding: 10px 15px;
ย ย ย ย ย ย background-color: rgba(22, 27, 34, 0.8);
ย ย ย ย ย ย color: var(--accent-color);
ย ย ย ย ย ย border: 2px solid var(--accent-color);
ย ย ย ย ย ย border-radius: 50%;
ย ย ย ย ย ย font-size: 1.5em;
ย ย ย ย ย ย cursor: pointer;
ย ย ย ย ย ย z-index: 10;
ย ย ย ย ย ย transition: background-color 0.2s, opacity 0.2s;
ย ย ย ย }

ย ย ย ย #scroll-left { left: 0; }
ย ย ย ย #scroll-right { right: 0; }

ย ย ย ย .scroll-button:hover {
ย ย ย ย ย ย background-color: var(--box-bg-color);
ย ย ย ย }

ย ย ย ย /* ------------------------------------------------------------------- */
ย ย ย ย /* EFECTO FLOTANTE MรGICO (BURBUJA/VORTEX) */
ย ย ย ย /* ------------------------------------------------------------------- */
ย ย ย ย .floating-ingredient {
ย ย ย ย ย ย position: absolute;ย
ย ย ย ย ย ย z-index: 100;
ย ย ย ย ย ย cursor: pointer;
ย ย ย ย ย ย text-align: center;
ย ย ย ย ย ย opacity: 0;ย
ย ย ย ย ย ย /* La transiciรณn se usa para la reubicaciรณn, caรญda y el efecto final de absorciรณn */
ย ย ย ย ย ย transition: transform 0.5s ease-in-out, opacity 0.5s, left 0.05s, top 0.05s;
ย ย ย ย ย ย animation: subtle-float 2s ease-in-out infinite alternate;
ย ย ย ย }
ย ย ย ยย
ย ย ย ย /* โญ๏ธ CAMBIO: Controlar el tamaรฑo dinรกmicamente con variables CSS */
ย ย ย ย .floating-ingredient.dynamic-size {
ย ย ย ย ย ย /* Las propiedades transform y scale serรกn manejadas por JS/inline style */
ย ย ย ย }
ย ย ย ยย
ย ย ย ย .ing-bubble-wrapper {
ย ย ย ย ย ย position: relative;
ย ย ย ย ย ย padding: 5px;ย
ย ย ย ย ย ย display: inline-block;
ย ย ย ย }

ย ย ย ย .ing-bubble {
ย ย ย ย ย ย width: 60px;
ย ย ย ย ย ย height: 60px;
ย ย ย ย ย ย border-radius: 50%;
ย ย ย ย ย ย background: rgba(88, 166, 255, 0.1);ย
ย ย ย ย ย ย border: 1px solid rgba(88, 166, 255, 0.6);
ย ย ย ย ย ย box-shadow: 0 0 15px rgba(88, 166, 255, 0.4), inset 0 0 10px rgba(255, 255, 255, 0.3);
ย ย ย ย ย ย display: flex;
ย ย ย ย ย ย justify-content: center;
ย ย ย ย ย ย align-items: center;
ย ย ย ย ย ย transition: all 0.5s ease-in-out;ย
ย ย ย ย }

ย ย ย ย .floating-ingredient .ing-emoji {
ย ย ย ย ย ย font-size: 2.5em;
ย ย ย ย ย ย line-height: 1;
ย ย ย ย ย ย position: relative;ย
ย ย ย ย ย ย z-index: 2;
ย ย ย ย }
ย ย ย ยย
ย ย ย ย .floating-ingredient .ing-name {
ย ย ย ย ย ย font-size: 0.7em;
ย ย ย ย ย ย font-weight: 600;
ย ย ย ย ย ย color: var(--text-color);
ย ย ย ย ย ย text-shadow: 0 0 5px var(--accent-color);
ย ย ย ย ย ย position: absolute;
ย ย ย ย ย ย bottom: -15px;ย
ย ย ย ย ย ย left: 50%;
ย ย ย ย ย ย transform: translateX(-50%);
ย ย ย ย ย ย width: 100%;
ย ย ย ย ย ย white-space: nowrap;
ย ย ย ย }

ย ย ย ย @keyframes subtle-float {
ย ย ย ย ย ย /* โญ๏ธ CAMBIO: La levitaciรณn ahora solo es la animaciรณn de respiraciรณn */
ย ย ย ย ย ย 0% { transform: translateY(-5px) scale(1.0); box-shadow: 0 0 15px rgba(88, 166, 255, 0.6); }
ย ย ย ย ย ย 100% { transform: translateY(5px) scale(1.05); box-shadow: 0 0 8px rgba(88, 166, 255, 0.3); }
ย ย ย ย }
ย ย ย ยย
ย ย ย ย /* Efecto de Caรญda / Burbuja Reventada */
ย ย ย ย .floating-ingredient.falling {
ย ย ย ย ย ย animation: none;ย
ย ย ย ย ย ย opacity: 0;
ย ย ย ย ย ย transition: transform 0.5s cubic-bezier(0.6, -0.28, 0.735, 0.045), opacity 0.5s;ย
ย ย ย ย ย ย transform: translateY(0) scale(0.2) !important;ย
ย ย ย ย }
ย ย ย ย .floating-ingredient.falling .ing-bubble {
ย ย ย ย ย ย background: transparent;
ย ย ย ย ย ย box-shadow: none;
ย ย ย ย ย ย border: 0;
ย ย ย ย ย ย transform: scale(3);ย
ย ย ย ย ย ย opacity: 0;
ย ย ย ย }

ย ย ย ย /* ------------------------------------------------------------------- */
ย ย ย ย /* BOTONES FIJOS DE ACCIรN */
ย ย ย ย /* ------------------------------------------------------------------- */
ย ย ย ย #fixed-actions {
ย ย ย ย ย ย position: fixed;
ย ย ย ย ย ย bottom: 20px;
ย ย ย ย ย ย left: 50%;
ย ย ย ย ย ย transform: translateX(-50%);
ย ย ย ย ย ย z-index: 200;
ย ย ย ย ย ย display: flex;
ย ย ย ย ย ย gap: 15px;
ย ย ย ย }

ย ย ย ย #accept-button, #toggle-list-button {
ย ย ย ย ย ย padding: 15px 25px;
ย ย ย ย ย ย color: white;
ย ย ย ย ย ย border: none;
ย ย ย ย ย ย border-radius: 50px;
ย ย ย ย ย ย font-size: 1.1em;
ย ย ย ย ย ย font-weight: bold;
ย ย ย ย ย ย cursor: pointer;
ย ย ย ย ย ย box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
ย ย ย ย ย ย transition: background-color 0.3s;
ย ย ย ย }

ย ย ย ย #accept-button {
ย ย ย ย ย ย background-color: var(--success-color);
ย ย ย ย }
ย ย ย ยย
ย ย ย ย #accept-button:disabled {
ย ย ย ย ย ย background-color: #30363d;
ย ย ย ย ย ย cursor: not-allowed;
ย ย ย ย }

ย ย ย ย #toggle-list-button {
ย ย ย ย ย ย background-color: var(--accent-color);
ย ย ย ย }

ย ย ย ย /* Contenedor del Vรณrtice de Animaciรณn */
ย ย ย ย #vortex-container {
ย ย ย ย ย ย position: fixed;
ย ย ย ย ย ย top: 0;
ย ย ย ย ย ย left: 0;
ย ย ย ย ย ย width: 100%;
ย ย ย ย ย ย height: 100%;
ย ย ย ย ย ย pointer-events: none;
ย ย ย ย ย ย z-index: 150;
ย ย ย ย ย ย display: none;
ย ย ย ย ย ย align-items: center;
ย ย ย ย ย ย justify-content: center;
ย ย ย ย }
ย ย ย ยย
ย ย ย ย .vortex {
ย ย ย ย ย ย width: 150px;
ย ย ย ย ย ย height: 150px;
ย ย ย ย ย ย background: radial-gradient(circle, rgba(0,0,0,0) 0%, var(--vortex-color) 70%, rgba(0,0,0,0) 100%);
ย ย ย ย ย ย border-radius: 50%;
ย ย ย ย ย ย animation: spin 1s linear infinite;
ย ย ย ย }
ย ย ย ยย
ย ย ย ย @keyframes spin {
ย ย ย ย ย ย from { transform: rotate(0deg); }
ย ย ย ย ย ย to { transform: rotate(360deg); }
ย ย ย ย }
ย ย ย ยย
ย ย </style>
</head>
<body>

ย ย <h2>El Taller del Mago: Recolecciรณn de Ingredientes โจ</h2>
ย ย <div id="loading-message" style="color: var(--accent-color); margin-bottom: 20px;">Cargando inventario mรกgico desde el grimorio...</div>
ย ย 
ย ย ย ย <div style="margin-bottom: 10px; font-size: 1.1em; color: #fff;">Mesa de levitaciรณn de ingredientes (Toca para devolver)</div>
ย ย <div id="levitation-area" style="position: relative; width: 90%; max-width: 800px; height: 180px; margin: 0 auto; border: 1px dashed #30363d; border-radius: 10px; opacity: 0.5;">
ย ย ย ย ย ย </div>

ย ย <div id="initial-selection-container" class="minimized">
ย ย ย ย <h3>Lista de Compras ๐</h3>
ย ย ย ย <p>Marca o desmarca los ingredientes para enviarlos a la cocina.</p>
ย ย ย ย <div id="initial-selection-list">ย
ย ย ย ย ย ย </div>
ย ย ย ย <button class="list-close-button" onclick="toggleInitialList('minimize')">Cerrar Lista</button>
ย ย </div>
ย ยย
ย ย <div id="gallery-wrapper">
ย ย ย ย <button id="scroll-left" class="scroll-button" onclick="scrollGallery(-1)">โ</button>
ย ย ย ย <div id="magic-boxes-gallery">
ย ย ย ย ย ย </div>
ย ย ย ย <button id="scroll-right" class="scroll-button" onclick="scrollGallery(1)">โ</button>
ย ย </div>
ย ยย
ย ย <div id="vortex-container">
ย ย ย ย <div class="vortex"></div>
ย ย </div>
ย ยย
ย ย <div id="fixed-actions">
ย ย ย ย <button id="toggle-list-button" onclick="toggleInitialList('maximize')">๐ Ver Lista de Compras</button>
ย ย ย ย <button id="accept-button" onclick="handleFinalAnimation()" disabled>Aceptar (0 ingredientes)</button>
ย ย </div>


<script>
ย ย // ===============================================
ย ย // LรGICA DE LA APLICACIรN (Embedded JS)
ย ย // ===============================================

ย ย // CONSTANTES Y VARIABLES GLOBALES
ย ย const loadingMessage = document.getElementById('loading-message');
ย ย const initialListContainer = document.getElementById('initial-selection-container');
ย ย const magicBoxesGallery = document.getElementById('magic-boxes-gallery');
ย ย const levitationArea = document.getElementById('levitation-area'); // โญ๏ธ Nuevo: รrea de levitaciรณn
ย ย const acceptButton = document.getElementById('accept-button');

ย ย // DATOS GLOBALES
ย ย let filteredInventory = [];ย
ย ย let selectedItems = new Set();
ย ย let floatingElements = new Map();
ย ย let inventoryDetailsMap = new Map();
ย ย const BUBBLE_SIZE = 70; // Tamaรฑo base de la burbuja flotante (60px + padding)
ย ยย
ย ย // En caso de que se cargue fuera del iframe, usamos una funciรณn placeholder
ย ย if (typeof window.loadContent !== 'function') {
ย ย ย ย ยwindow.loadContent = (url) => console.log(`DEBUG: Navegando a ${url}`);
ย ย }
ย ยย
ย ย // ===============================================
ย ย // PERSISTENCIA LOCAL Y SINCRONIZACIรN DE ESTADO
ย ย // ===============================================

ย ย function saveSelectionToStorage() {
ย ย ย ย const selectionData = {
ย ย ย ย ย ย selectedItems: Array.from(selectedItems),
ย ย ย ย };
ย ย ย ย localStorage.setItem('magicIngredientSelection', JSON.stringify(selectionData));
ย ย ย ย updateAcceptButton();
ย ย }
ย ยย
ย ย function loadSelectionFromStorage() {
ย ย ย ย const localSelection = localStorage.getItem('magicIngredientSelection');
ย ย ย ย if (localSelection) {
ย ย ย ย ย ย const selection = JSON.parse(localSelection);
ย ย ย ย ย ย selectedItems = new Set(selection.selectedItems);
ย ย ย ย }
ย ย }
ย ยย
ย ย function updateAcceptButton() {
ย ย ย ย acceptButton.textContent = `Aceptar (${selectedItems.size} ingredientes)`;
ย ย ย ย acceptButton.disabled = selectedItems.size === 0;
ย ย }

ย ย // ===============================================
ย ย // LรGICA DE NAVEGACIรN HORIZONTAL (Scroll)
ย ย // ===============================================
ย ยย
ย ย function scrollGallery(direction) {
ย ย ย ย const scrollAmount = magicBoxesGallery.clientWidth * 0.8;ย
ย ย ย ยย
ย ย ย ย if (direction === 1) {
ย ย ย ย ย ย magicBoxesGallery.scrollLeft += scrollAmount;
ย ย ย ย } else {
ย ย ย ย ย ย magicBoxesGallery.scrollLeft -= scrollAmount;
ย ย ย ย }
ย ย }


ย ย // ===============================================
ย ย // LรGICA DE SELECCIรN MรGICA
ย ย // ===============================================

ย ย function handleSelection(ingName) {
ย ย ย ย const isSelected = selectedItems.has(ingName);
ย ย ย ย const ingData = inventoryDetailsMap.get(ingName);
ย ย ย ยย
ย ย ย ย if (!ingData) return;

ย ย ย ย const boxSlot = document.querySelector(`.ing-slot[data-name="${ingName}"]`);
ย ย ย ยย
ย ย ย ย if (isSelected) {
ย ย ย ย ย ย // DESELECCIONAR: Aplicar animaciรณn de caรญda/reventรณn
ย ย ย ย ย ย selectedItems.delete(ingName);
ย ย ย ย ย ย removeFloatingElement(ingName);
ย ย ย ย ย ย if (boxSlot) boxSlot.style.visibility = 'visible';
ย ย ย ย } else {
ย ย ย ย ย ย // SELECCIONAR: Aplicar animaciรณn de flotar (creaciรณn de burbuja)
ย ย ย ย ย ย selectedItems.add(ingName);
ย ย ย ย ย ยย
ย ย ย ย ย ย if (boxSlot) {
ย ย ย ย ย ย ย ย boxSlot.style.visibility = 'hidden';
ย ย ย ย ย ย ย ย // Creamos el elemento flotante, la funciรณn lo posiciona
ย ย ย ย ย ย ย ย createFloatingElement(ingData, boxSlot);ย
ย ย ย ย ย ย }
ย ย ย ย }
ย ย ย ยย
ย ย ย ย saveSelectionToStorage();
ย ย ย ย // Sincronizar el checkbox en la lista de compras
ย ย ย ย const checklistCheckbox = document.querySelector(`#checklist-${ingName.replace(/\s/g, '_')}`);
ย ย ย ย if (checklistCheckbox) checklistCheckbox.checked = selectedItems.has(ingName);
ย ย ย ยย
ย ย ย ย updateFloatingPositions(); // โญ๏ธ Actualizar todas las posiciones al seleccionar/deseleccionar
ย ย }
ย ยย
ย ย /**
ย ย ย* Calcula las posiciones de los ingredientes seleccionados en la Mesa de Levitaciรณn.
ย ย ย*/
ย ย function updateFloatingPositions() {
ย ย ย ย if (selectedItems.size === 0) return;

ย ย ย ย const selectedArray = Array.from(selectedItems).map(name => floatingElements.get(name)).filter(el => el);
ย ย ย ย const count = selectedArray.length;
ย ย ย ย if (count === 0) return;

ย ย ย ย const rect = levitationArea.getBoundingClientRect();
ย ย ย ย const areaWidth = rect.width;
ย ย ย ย const areaHeight = rect.height;
ย ย ย ย const offsetTop = rect.top + window.scrollY;
ย ย ย ย const offsetLeft = rect.left;

ย ย ย ย // Lรณgica de distribuciรณn en cuadrรญcula adaptable
ย ย ย ย const maxPerRow = Math.min(Math.ceil(Math.sqrt(count * 1.5)), 8);
ย ย ย ย const rows = Math.ceil(count / maxPerRow);
ย ย ย ยย
ย ย ย ย // Determinar el tamaรฑo de la burbuja (factor de escala)
ย ย ย ย let scaleFactor = 1;
ย ย ย ย let elementSize = BUBBLE_SIZE;
ย ย ย ยย
ย ย ย ย // Si hay muchos, reducir el tamaรฑo para que quepan
ย ย ย ย if (count > 10) {
ย ย ย ย ย ย scaleFactor = Math.max(0.7, 1 - (count - 10) * 0.05); // Reduce hasta 70%
ย ย ย ย ย ย elementSize = BUBBLE_SIZE * scaleFactor;
ย ย ย ย }
ย ย ย ยย
ย ย ย ย // Espaciado entre elementos
ย ย ย ย const spacingX = Math.max(20, (areaWidth - maxPerRow * elementSize) / (maxPerRow + 1));
ย ย ย ย const spacingY = Math.max(20, (areaHeight - rows * elementSize) / (rows + 1));
ย ย ย ยย
ย ย ย ย selectedArray.forEach((el, index) => {
ย ย ย ย ย ย const row = Math.floor(index / maxPerRow);
ย ย ย ย ย ย const col = index % maxPerRow;
ย ย ย ย ย ยย
ย ย ย ย ย ย // Calcular la posiciรณn dentro del รกrea de levitaciรณn
ย ย ย ย ย ย const xInArea = spacingX + col * (elementSize + spacingX);
ย ย ย ย ย ย const yInArea = spacingY + row * (elementSize + spacingY);

ย ย ย ย ย ย // Posiciรณn final en el documento (centrar el elemento)
ย ย ย ย ย ย const finalLeft = offsetLeft + xInArea - (elementSize / 2);
ย ย ย ย ย ย const finalTop = offsetTop + yInArea - (elementSize / 2);
ย ย ย ย ย ยย
ย ย ย ย ย ย // โญ๏ธ Aplicar nueva posiciรณn y escala con una transiciรณn suave
ย ย ย ย ย ย el.style.left = `${finalLeft}px`;
ย ย ย ย ย ย el.style.top = `${finalTop}px`;
ย ย ย ย ย ยย
ย ย ย ย ย ย // Aplicar la escala directamente con la animaciรณn de levitaciรณn (float)
ย ย ย ย ย ย el.style.transform = `scale(${scaleFactor})`;
ย ย ย ย ย ย el.classList.add('dynamic-size'); // Para control CSS si es necesario
ย ย ย ย });
ย ย }


ย ย /**
ย ย ย* Crea un ingrediente flotante con efecto de burbuja, posicionado inicialmente sobre su slot de caja.
ย ย ย*/
ย ย function createFloatingElement(ingData, sourceElement) {
ย ย ย ย if (floatingElements.has(ingData.nombre)) return;

ย ย ย ย const targetSlot = document.querySelector(`.magic-box .ing-slot[data-name="${ingData.nombre}"]`);
ย ย ย ย if (!targetSlot) return;ย

ย ย ย ย const rect = targetSlot.getBoundingClientRect();
ย ย ย ย const galleryRect = magicBoxesGallery.getBoundingClientRect();
ย ย ย ยย
ย ย ย ย const floatingEl = document.createElement('div');
ย ย ย ย floatingEl.classList.add('floating-ingredient');
ย ย ย ย floatingEl.setAttribute('data-name', ingData.nombre);
ย ย ย ยย
ย ย ย ย floatingEl.innerHTML = `
ย ย ย ย ย ย <div class="ing-bubble-wrapper">
ย ย ย ย ย ย ย ย <div class="ing-bubble">
ย ย ย ย ย ย ย ย ย ย <div class="ing-emoji">${ingData.emoji}</div>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย </div>
ย ย ย ย ย ย <div class="ing-name">${ingData.nombre}</div>
ย ย ย ย `;

ย ย ย ย document.body.appendChild(floatingEl);
ย ย ย ยย
ย ย ย ย const bubbleSizeOffset = 30;

ย ย ย ย // Calcular posiciรณn de origen (sobre el slot de la caja)
ย ย ย ย const slotXInScrollContent = (rect.left - galleryRect.left) + magicBoxesGallery.scrollLeft;
ย ย ย ย const offsetXFromSlotCenter = rect.width / 2 - bubbleSizeOffset;ย
ย ย ย ย const initialLeft = slotXInScrollContent + galleryRect.left + offsetXFromSlotCenter;
ย ย ย ย const initialTop = rect.top + window.scrollY - bubbleSizeOffset;ย
ย ย ย ยย
ย ย ย ย // 1. Establecer la posiciรณn (posiciรณn de origen temporal)
ย ย ย ย floatingEl.style.left = `${initialLeft}px`;
ย ย ย ย floatingEl.style.top = `${initialTop}px`;ย
ย ย ย ยย
ย ย ย ย floatingEl.style.transform = 'scale(0.2)'; // Empieza pequeรฑo

ย ย ย ย // 2. Iniciar la animaciรณn de levitaciรณn (luego se moverรก a la zona central)
ย ย ย ย requestAnimationFrame(() => {
ย ย ย ย ย ย floatingEl.style.opacity = '1';
ย ย ย ย ย ย floatingEl.style.transition = 'transform 0.5s ease-in-out, opacity 0.5s, left 0.5s, top 0.5s'; // Transiciรณn para el movimiento a la zona central
ย ย ย ย ย ยย
ย ย ย ย ย ย // Despuรฉs de una breve pausa, mover a la posiciรณn de levitaciรณn
ย ย ย ย ย ย setTimeout(updateFloatingPositions, 50);ย
ย ย ย ย });

ย ย ย ย floatingEl.addEventListener('click', () => {
ย ย ย ย ย ย handleSelection(ingData.nombre);
ย ย ย ย });

ย ย ย ย floatingElements.set(ingData.nombre, floatingEl);
ย ย }
ย ยย
ย ย /**
ย ย ย* Devuelve el ingrediente al slot con animaciรณn de caรญda/reventรณn de burbuja.
ย ย ย*/
ย ย function removeFloatingElement(ingName) {
ย ย ย ย const el = floatingElements.get(ingName);
ย ย ย ย if (el) {
ย ย ย ย ย ย // Encontrar el slot de destino (posiciรณn final de la caรญda)
ย ย ย ย ย ย const targetSlot = document.querySelector(`.magic-box .ing-slot[data-name="${ingName}"]`);
ย ย ย ย ย ย if (targetSlot) {
ย ย ย ย ย ย ย ย const rect = targetSlot.getBoundingClientRect();
ย ย ย ย ย ย ย ย const galleryRect = magicBoxesGallery.getBoundingClientRect();
ย ย ย ย ย ย ย ย const bubbleSizeOffset = 30;ย
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย const slotXInScrollContent = (rect.left - galleryRect.left) + magicBoxesGallery.scrollLeft;
ย ย ย ย ย ย ย ย const offsetXFromSlotCenter = rect.width / 2 - bubbleSizeOffset;
ย ย ย ย ย ย ย ย const finalLeft = slotXInScrollContent + galleryRect.left + offsetXFromSlotCenter;

ย ย ย ย ย ย ย ย const finalTop = rect.top + window.scrollY - bubbleSizeOffset;

ย ย ย ย ย ย ย ย // Forzar la posiciรณn final para que el CSS 'falling' haga la transiciรณn.
ย ย ย ย ย ย ย ย // Necesitamos desactivar la animaciรณn 'subtle-float' y aplicar la clase 'falling'
ย ย ย ย ย ย ย ย el.style.animation = 'none';
ย ย ย ย ย ย ย ย el.classList.add('falling');
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย el.style.left = `${finalLeft}px`;
ย ย ย ย ย ย ย ย el.style.top = `${finalTop}px`;
ย ย ย ย ย ย }

ย ย ย ย ย ย // Eliminar despuรฉs de que la animaciรณn termine (500ms)
ย ย ย ย ย ย setTimeout(() => {
ย ย ย ย ย ย ย ย el.remove();
ย ย ย ย ย ย ย ย floatingElements.delete(ingName);
ย ย ย ย ย ย ย ย updateFloatingPositions(); // Recalcular las posiciones restantes
ย ย ย ย ย ย }, 500);ย
ย ย ย ย }
ย ย }


ย ย // ===============================================
ย ย // RENDERIZADO Y UTILIDADES
ย ย // ===============================================
ย ยย
ย ย function groupIngredients(ingredients) {
ย ย ย ย const groups = [];
ย ย ย ย for (let i = 0; i < ingredients.length; i += 5) {
ย ย ย ย ย ย groups.push(ingredients.slice(i, i + 5));
ย ย ย ย }
ย ย ย ย return groups;
ย ย }

ย ย function renderMagicBoxes() {
ย ย ย ย magicBoxesGallery.innerHTML = '';
ย ย ย ยย
ย ย ย ย // Limpiar elementos flotantes pre-existentes
ย ย ย ย floatingElements.forEach(el => el.remove());
ย ย ย ย floatingElements.clear();

ย ย ย ย const ingredientGroups = groupIngredients(filteredInventory);
ย ย ย ยย
ย ย ย ย ingredientGroups.forEach((group, index) => {
ย ย ย ย ย ย const box = document.createElement('div');
ย ย ย ย ย ย box.classList.add('magic-box');
ย ย ย ย ย ย box.innerHTML = `<div class="box-title">Caja Mรกgica ${index + 1}</div>`;
ย ย ย ย ย ยย
ย ย ย ย ย ย group.forEach(ingData => {
ย ย ย ย ย ย ย ย const isSelected = selectedItems.has(ingData.nombre);
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย const slot = document.createElement('div');
ย ย ย ย ย ย ย ย slot.classList.add('ing-slot');
ย ย ย ย ย ย ย ย slot.setAttribute('data-name', ingData.nombre);
ย ย ย ย ย ย ย ย slot.innerHTML = ingData.emoji;
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย if (isSelected) {
ย ย ย ย ย ย ย ย ย ย slot.style.visibility = 'hidden';
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย slot.addEventListener('click', () => {
ย ย ย ย ย ย ย ย ย ย handleSelection(ingData.nombre);
ย ย ย ย ย ย ย ย });
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย box.appendChild(slot);
ย ย ย ย ย ย });
ย ย ย ย ย ยย
ย ย ย ย ย ย magicBoxesGallery.appendChild(box);
ย ย ย ย });
ย ย ย ยย
ย ย ย ย // Post-renderizado: Crear elementos flotantes que ya estaban seleccionados
ย ย ย ย filteredInventory.forEach(ingData => {
ย ย ย ย ย ย if (selectedItems.has(ingData.nombre)) {
ย ย ย ย ย ย ย ย const sourceSlot = document.querySelector(`.ing-slot[data-name="${ingData.nombre}"]`);
ย ย ย ย ย ย ย ย if (sourceSlot) {
ย ย ย ย ย ย ย ย ย ย // Se usa createFloatingElement para que se mueva de la caja a la mesa de levitaciรณn.
ย ย ย ย ย ย ย ย ย ย setTimeout(() => createFloatingElement(ingData, sourceSlot), 10);ย
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย }
ย ย ย ย });
ย ย ย ยย
ย ย ย ย // โญ๏ธ Actualizar posiciones de levitaciรณn despuรฉs de crear todos los elementos
ย ย ย ย setTimeout(updateFloatingPositions, 100); 
ย ย }

ย ย function renderInitialList() {
ย ย ย ย const listContainer = document.getElementById('initial-selection-list');
ย ย ย ย listContainer.innerHTML = '';

ย ย ย ย filteredInventory.forEach(ingData => {
ย ย ย ย ย ย const isSelected = selectedItems.has(ingData.nombre);
ย ย ย ย ย ย const item = document.createElement('div');
ย ย ย ย ย ย item.classList.add('initial-item');
ย ย ย ย ย ยย
ย ย ย ย ย ย item.innerHTML = `
ย ย ย ย ย ย ย ย <input type="checkbox" id="checklist-${ingData.nombre.replace(/\s/g, '_')}" ${isSelected ? 'checked' : ''} data-name="${ingData.nombre}">
ย ย ย ย ย ย ย ย <label for="checklist-${ingData.nombre.replace(/\s/g, '_')}">${ingData.emoji} ${ingData.nombre} (${ingData.cantidad_disponible || 'N/A'})</label>
ย ย ย ย ย ย `;
ย ย ย ย ย ยย
ย ย ย ย ย ย const checkbox = item.querySelector('input[type="checkbox"]');
ย ย ย ย ย ย checkbox.addEventListener('change', () => {
ย ย ย ย ย ย ย ย handleSelection(ingData.nombre);ย
ย ย ย ย ย ย });

ย ย ย ย ย ย listContainer.appendChild(item);
ย ย ย ย });
ย ย }
ย ยย
ย ย function toggleInitialList(action) {
ย ย ย ย if (action === 'minimize') {
ย ย ย ย ย ย initialListContainer.classList.add('minimized');
ย ย ย ย } else {
ย ย ย ย ย ย initialListContainer.classList.remove('minimized');
ย ย ย ย }
ย ย }
ย ยย
ย ย // ===============================================
ย ย // ANIMACIรN FINAL Y NAVEGACIรN
ย ย // ===============================================

ย ย async function handleFinalAnimation() {
ย ย ย ย if (selectedItems.size === 0) return;
ย ย ย ยย
ย ย ย ย acceptButton.disabled = true;
ย ย ย ย const toggleListButton = document.getElementById('toggle-list-button');
ย ย ย ย toggleListButton.disabled = true;

ย ย ย ย const vortexContainer = document.getElementById('vortex-container');
ย ย ย ย vortexContainer.style.display = 'flex';
ย ย ย ยย
ย ย ย ย // Obtener la posiciรณn del vรณrtice para el destino
ย ย ย ย const vortexRect = vortexContainer.getBoundingClientRect();
ย ย ย ย const centerVortexX = vortexRect.left + vortexRect.width / 2;
ย ย ย ย const centerVortexY = vortexRect.top + vortexRect.height / 2;

ย ย ย ย // โญ๏ธ CAMBIO: Aplicar animaciรณn de espiral al centro de la pantalla
ย ย ย ย floatingElements.forEach((el) => {
ย ย ย ย ย ย const rect = el.getBoundingClientRect();
ย ย ย ย ย ยย
ย ย ย ย ย ย // Calcular la traslaciรณn al centro del vรณrtice
ย ย ย ย ย ย const translateX = centerVortexX - (rect.left + rect.width / 2);
ย ย ย ย ย ย const translateY = centerVortexY - (rect.top + rect.height / 2);
ย ย ย ย ย ยย
ย ย ย ย ย ย // Aplicar la animaciรณn de espiral (giro y reducciรณn)
ย ย ย ย ย ย el.style.transition = 'transform 1.5s cubic-bezier(0.5, 0.0, 0.5, 1.0), opacity 1.5s'; // Curva mรกgica
ย ย ย ย ย ย el.style.transform = `
ย ย ย ย ย ย ย ย translate(${translateX}px, ${translateY}px)ย
ย ย ย ย ย ย ย ย scale(0.01)ย
ย ย ย ย ย ย ย ย rotate(720deg)ย
ย ย ย ย ย ย `;
ย ย ย ย ย ยย
ย ย ย ย ย ย el.style.opacity = '1';ย
ย ย ย ย ย ย el.style.animation = 'none'; // Detener la levitaciรณn
ย ย ย ย ย ยย
ย ย ย ย ย ย // Desvanecer el ingrediente justo cuando la animaciรณn termina (1.5s)
ย ย ย ย ย ย setTimeout(() => {
ย ย ย ย ย ย ย ย el.style.opacity = '0';
ย ย ย ย ย ย }, 1000);ย
ย ย ย ย });

ย ย ย ย await new Promise(resolve => setTimeout(resolve, 1500));
ย ย ย ยย
ย ย ย ย floatingElements.forEach(el => el.remove());
ย ย ย ย vortexContainer.style.display = 'none';

ย ย ย ย saveSelectionToStorage();

ย ย ย ย // Llamar a loadContent en el contexto padre para la navegaciรณn
ย ย ย ย if (window.parent && typeof window.parent.loadContent === 'function') {
ย ย ย ย ย ย window.parent.loadContent('pantalla4.html');
ย ย ย ย } else {
ย ย ย ย ย ย window.loadContent('pantalla4.html');
ย ย ย ย }ย
ย ย }

ย ย // ===============================================
ย ย // INICIALIZACIรN PRINCIPAL
ย ย // ===============================================
ย ย 
ย ย // โญ๏ธ Nuevo: Event listener para actualizar la posiciรณn al hacer scroll/resize
ย ย window.addEventListener('scroll', updateFloatingPositions);
ย ย window.addEventListener('resize', updateFloatingPositions);

ย ย async function loadMenuData() {
ย ย ย ย try {
ย ย ย ย ย ย loadingMessage.textContent = 'Buscando el grimorio de ingredientes en el almacรฉn mรกgico...';
ย ย ย ย ย ยย
ย ย ย ย ย ย let dataLoaded = null;

ย ย ย ย ย ย // 1. Intento principal: Acceder a la variable global del contexto padre (window.parent)
ย ย ย ย ย ย if (window.parent && window.parent.inventarioData) {
ย ย ย ย ย ย ย ย dataLoaded = window.parent.inventarioData;
ย ย ย ย ย ย ย ย loadingMessage.textContent = 'รxito: Datos cargados directamente del padre.';
ย ย ย ย ย ย }

ย ย ย ย ย ย // 2. Respaldo: Si fallรณ el parent, intentar cargar desde localStorage
ย ย ย ย ย ย if (!dataLoaded) {
ย ย ย ย ย ย ย ย ยloadingMessage.textContent = 'El grimorio del padre no respondiรณ, intentando leer la copia local...';
ย ย ย ย ย ย ย ย ยconst localData = localStorage.getItem('inventarioData');
ย ย ย ย ย ย ย ย ยif (localData) {
ย ย ย ย ย ย ย ย ย ย try {
ย ย ย ย ย ย ย ย ย ย ย ย dataLoaded = JSON.parse(localData);
ย ย ย ย ย ย ย ย ย ย ย ย loadingMessage.textContent = 'รxito: Datos cargados desde localStorage.';
ย ย ย ย ย ย ย ย ย ย } catch (e) {
ย ย ย ย ย ย ย ย ย ย ย ย console.error("Error al parsear inventarioData de localStorage:", e);
ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย ย}
ย ย ย ย ย ย }
ย ย ย ย ย ยย
ย ย ย ย ย ย // 3. Verificar si los datos fueron cargados
ย ย ย ย ย ย if (dataLoaded && Array.isArray(dataLoaded)) {
ย ย ย ย ย ย ย ย filteredInventory = dataLoaded.filter(item => item.activo === true);
ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย throw new Error("El inventarioData del grimorio no se pudo cargar o no estรก disponible.");
ย ย ย ย ย ย }
ย ย ย ย ย ยย
ย ย ย ย ย ย // 4. Crear el mapa de detalles
ย ย ย ย ย ย filteredInventory.forEach(item => {
ย ย ย ย ย ย ย ย inventoryDetailsMap.set(item.nombre, item);
ย ย ย ย ย ย });

ย ย ย ย ย ย // 5. Cargar la selecciรณn previa y sincronizar
ย ย ย ย ย ย loadSelectionFromStorage();

ย ย ย ย ย ย // 6. Renderizar las dos vistas
ย ย ย ย ย ย renderInitialList();
ย ย ย ย ย ยย
ย ย ย ย ย ย setTimeout(() => {
ย ย ย ย ย ย ย ย renderMagicBoxes();
ย ย ย ย ย ย ย ย toggleInitialList('minimize'); // Asegurar que la lista de compras estรฉ oculta al inicio
ย ย ย ย ย ย ย ย loadingMessage.textContent = 'ยกInventario cargado! Recolecta tus ingredientes.';
ย ย ย ย ย ย ย ย updateAcceptButton();
ย ย ย ย ย ย ย ย updateFloatingPositions(); // Asegurar la posiciรณn inicial de los ingredientes ya seleccionados
ย ย ย ย ย ย }, 50);


ย ย ย ย } catch (error) {
ย ย ย ย ย ย loadingMessage.style.color = '#f75555';
ย ย ย ย ย ย loadingMessage.textContent = `ERROR MรGICO: ${error.message}`;
ย ย ย ย ย ย console.error("Fallo la carga de datos mรกgicos:", error);
ย ย ย ย }
ย ย }
ย ยย
ย ย loadMenuData();ย
</script>
</body>
</html>
