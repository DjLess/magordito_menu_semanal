<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>El Taller del Mago: Selecci√≥n de Ingredientes</title>
    
    <style>
        /* ======================================================================= */
        /* VARIABLES Y ESTILOS BASE (Tema Oscuro M√°gico) */
        /* ======================================================================= */
        :root {
            --bg-color: #0d1117;
            --text-color: #c9d1d9;
            --accent-color: #58a6ff; /* Azul m√°gico */
            --success-color: #238636;
            --box-bg-color: #161b22; /* Fondo de las cajas m√°gicas */
            --box-border-color: #30363d;
            --vortex-color: rgba(88, 166, 255, 0.8);
            --ingredient-lift: 50px; /* Distancia de levitaci√≥n */
            
            /* NUEVA ZONA DE FLOTACI√ìN: Offset vertical (donde estaba la galer√≠a) */
            --floating-area-top: 150px; 
            --floating-area-height: 250px; 
        }
        
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 10px;
            text-align: center;
            font-size: 0.9em;
            overflow-x: hidden;
            position: relative;
        }
        
        h2 {
            font-size: 1.6em;
            color: var(--accent-color);
            margin-bottom: 20px;
        }

        /* ------------------------------------------------------------------- */
        /* CONTENEDOR DE LISTA INICIAL (Overlay Flotante/Lista de Compras) */
        /* ------------------------------------------------------------------- */
        #initial-selection-container {
            background-color: #1f242b;
            border: 1px solid var(--box-border-color);
            border-radius: 8px;
            padding: 15px;
            /* Posicionamiento Fixed para Overlay */
            position: fixed; 
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.8); 
            z-index: 1000; 
            max-width: 90%; 
            max-height: 90vh;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7);
            
            /* Estado inicial Oculto */
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease-out, transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94); 
        }

        /* Estado Visible (Maximizado) */
        #initial-selection-container:not(.minimized) {
            opacity: 1;
            pointer-events: all;
            transform: translate(-50%, -50%) scale(1);
        }

        #initial-selection-list {
            max-height: 400px;
            overflow-y: auto;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            padding-top: 10px;
            text-align: left;
        }
        
        .initial-item {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 5px;
            border-bottom: 1px dashed #30363d;
        }
        
        .list-close-button {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
            background-color: #ffa500; 
            color: #161b22;
        }

        /* ------------------------------------------------------------------- */
        /* GALER√çA DE CAJAS M√ÅGICAS (Simulando el Supermercado) */
        /* ------------------------------------------------------------------- */

        /* DESPLAZAMIENTO: Mueve el contenedor principal de la galer√≠a 200px hacia abajo */
        #gallery-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            margin: 0 auto;
            position: relative;
            margin-top: 200px; /* <--- EDICI√ìN 1: Desplazamiento de la galer√≠a */
        }
        
        /* Contenedor principal de las cajas: habilita el scroll horizontal */
        #magic-boxes-gallery {
            display: flex;
            flex-wrap: nowrap; 
            overflow-x: scroll; 
            overflow-y: hidden;
            scroll-behavior: smooth; 
            gap: 20px;
            padding: 20px 0;
            width: 90%; 
            -webkit-overflow-scrolling: touch;
        }
        
        /* Ocultar la barra de scroll nativa (Opcional, para est√©tica) */
        #magic-boxes-gallery::-webkit-scrollbar {
            display: none;
        }
        #magic-boxes-gallery {
            -ms-overflow-style: none; /* IE and Edge */
            scrollbar-width: none; /* Firefox */
        }
        
        .magic-box {
            width: 150px;
            min-width: 150px; 
            height: 150px;
            background-color: var(--box-bg-color);
            border: 3px solid var(--box-border-color);
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
            position: relative;
            padding: 10px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 5px;
            transition: border-color 0.3s;
        }

        .box-title {
            position: absolute;
            top: -15px;
            background: var(--bg-color);
            padding: 0 8px;
            border-radius: 5px;
            font-size: 0.8em;
            color: #ffa500;
            font-weight: bold;
        }

        .ing-slot {
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5em;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        
        .ing-slot:hover {
            background-color: #30363d;
        }
        
        /* Flechas de Navegaci√≥n */
        .scroll-button {
            position: absolute;
            padding: 10px 15px;
            background-color: rgba(22, 27, 34, 0.8);
            color: var(--accent-color);
            border: 2px solid var(--accent-color);
            border-radius: 50%;
            font-size: 1.5em;
            cursor: pointer;
            z-index: 10;
            transition: background-color 0.2s, opacity 0.2s;
        }

        #scroll-left { left: 0; }
        #scroll-right { right: 0; }

        .scroll-button:hover {
            background-color: var(--box-bg-color);
        }

        /* ------------------------------------------------------------------- */
        /* EFECTO FLOTANTE M√ÅGICO (BURBUJA/VORTEX) */
        /* ------------------------------------------------------------------- */
        .floating-ingredient {
            position: absolute; 
            z-index: 100;
            cursor: pointer;
            text-align: center;
            opacity: 0; 
            /* Modificaci√≥n: Usamos transform para la levitaci√≥n y las propiedades left/top para el posicionamiento din√°mico */
            transition: transform 0.5s ease-in-out, opacity 0.5s, left 0.5s ease-out, top 0.5s ease-out; /* <- Transiciones m√°s suaves para el reposicionamiento */
            animation: subtle-float 2s ease-in-out infinite alternate;
        }

        .ing-bubble-wrapper {
            position: relative;
            padding: 5px; 
            display: inline-block;
        }

        .ing-bubble {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(88, 166, 255, 0.1); 
            border: 1px solid rgba(88, 166, 255, 0.6);
            box-shadow: 0 0 15px rgba(88, 166, 255, 0.4), inset 0 0 10px rgba(255, 255, 255, 0.3);
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.5s ease-in-out; 
        }

        .floating-ingredient .ing-emoji {
            font-size: 2.5em;
            line-height: 1;
            position: relative; 
            z-index: 2;
        }
        
        .floating-ingredient .ing-name {
            font-size: 0.7em;
            font-weight: 600;
            color: var(--text-color);
            text-shadow: 0 0 5px var(--accent-color);
            position: absolute;
            bottom: -15px; 
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            white-space: nowrap;
        }

        @keyframes subtle-float {
            /* Mantenemos el efecto de levitaci√≥n vertical sutil */
            0% { transform: translateY(0) scale(1.0); box-shadow: 0 0 15px rgba(88, 166, 255, 0.6); }
            100% { transform: translateY(-5px) scale(1.0); box-shadow: 0 0 8px rgba(88, 166, 255, 0.3); }
        }
        
        /* Efecto de Ca√≠da / Burbuja Reventada */
        .floating-ingredient.falling {
            animation: none; 
            opacity: 0;
            /* La ca√≠da/explosi√≥n ocurre en su posici√≥n actual antes de ser eliminada */
            transition: transform 0.5s cubic-bezier(0.6, -0.28, 0.735, 0.045), opacity 0.5s, left 0.05s, top 0.05s; 
            transform: translateY(20px) scale(0.2) !important; /* Desaparece hacia abajo */
        }
        .floating-ingredient.falling .ing-bubble {
            background: transparent;
            box-shadow: none;
            border: 0;
            transform: scale(3); 
            opacity: 0;
        }
        
        /* Animaci√≥n Final: Giro en Espiral */
        @keyframes spiral-to-center {
            0% { transform: scale(1) rotate(0deg); opacity: 1; }
            50% { transform: scale(0.5) rotate(360deg); opacity: 1; }
            100% { transform: scale(0.01) rotate(720deg); opacity: 0; }
        }

        /* ------------------------------------------------------------------- */
        /* BOTONES FIJOS DE ACCI√ìN */
        /* ------------------------------------------------------------------- */
        #fixed-actions {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 200;
            display: flex;
            gap: 15px;
        }

        #accept-button, #toggle-list-button {
            padding: 15px 25px;
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            transition: background-color 0.3s;
        }

        #accept-button {
            background-color: var(--success-color);
        }
        
        #accept-button:disabled {
            background-color: #30363d;
            cursor: not-allowed;
        }

        #toggle-list-button {
            background-color: var(--accent-color);
        }

        /* Contenedor del V√≥rtice de Animaci√≥n */
        #vortex-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 150;
            display: none;
            align-items: center;
            justify-content: center;
        }
        
        .vortex {
            width: 150px;
            height: 150px;
            background: radial-gradient(circle, rgba(0,0,0,0) 0%, var(--vortex-color) 70%, rgba(0,0,0,0) 100%);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
    </style>
</head>
<body>

    <h2>El Taller del Mago: Recolecci√≥n de Ingredientes ‚ú®</h2>
    <div id="loading-message" style="color: var(--accent-color); margin-bottom: 20px;">Cargando inventario m√°gico desde el grimorio...</div>

    <div style="margin-bottom: 10px; font-size: 1.1em; color: var(--accent-color);">Ingredientes Seleccionados (Flotando)</div>
    <div style="height: 150px; border: 1px dashed #30363d; margin: 0 5%; display: flex; justify-content: center; align-items: center; color: #30363d; background-color: #0d0f13; position: relative; top: -10px;">
        <span id="floating-area-message">Selecciona ingredientes de las cajas de abajo.</span>
    </div>
    <div id="initial-selection-container" class="minimized">
        <h3>Lista de Compras üõí</h3>
        <p>Marca o desmarca los ingredientes para enviarlos a la cocina.</p>
        <div id="initial-selection-list"> 
            </div>
        <button class="list-close-button" onclick="toggleInitialList('minimize')">Cerrar Lista</button>
    </div>
    
    <div id="gallery-wrapper">
        <button id="scroll-left" class="scroll-button" onclick="scrollGallery(-1)">‚Üê</button>
        <div id="magic-boxes-gallery">
            </div>
        <button id="scroll-right" class="scroll-button" onclick="scrollGallery(1)">‚Üí</button>
    </div>
    
    <div id="vortex-container">
        <div class="vortex"></div>
    </div>
    
    <div id="fixed-actions">
        <button id="toggle-list-button" onclick="toggleInitialList('maximize')">üõí Ver Lista de Compras</button>
        <button id="accept-button" onclick="handleFinalAnimation()" disabled>Aceptar (0 ingredientes)</button>
    </div>


<script>
    // ===============================================
    // L√ìGICA DE LA APLICACI√ìN (Embedded JS)
    // ===============================================

    // CONSTANTES Y VARIABLES GLOBALES
    const loadingMessage = document.getElementById('loading-message');
    const initialListContainer = document.getElementById('initial-selection-container');
    const magicBoxesGallery = document.getElementById('magic-boxes-gallery');
    const acceptButton = document.getElementById('accept-button');
    const floatingAreaMessage = document.getElementById('floating-area-message');

    // DATOS GLOBALES
    let filteredInventory = []; 
    let selectedItems = new Set();
    let floatingElements = new Map();
    let inventoryDetailsMap = new Map();

    // En caso de que se cargue fuera del iframe, usamos una funci√≥n placeholder
    if (typeof window.loadContent !== 'function') {
         window.loadContent = (url) => console.log(`DEBUG: Navegando a ${url}`);
    }
    
    // ===============================================
    // PERSISTENCIA LOCAL Y SINCRONIZACI√ìN DE ESTADO
    // ===============================================

    function saveSelectionToStorage() {
        const selectionData = {
            selectedItems: Array.from(selectedItems),
        };
        localStorage.setItem('magicIngredientSelection', JSON.stringify(selectionData));
        updateAcceptButton();
        updateFloatingArea(); // <--- Llamada a la nueva funci√≥n de layout
    }
    
    function loadSelectionFromStorage() {
        const localSelection = localStorage.getItem('magicIngredientSelection');
        if (localSelection) {
            const selection = JSON.parse(localSelection);
            selectedItems = new Set(selection.selectedItems);
        }
    }
    
    function updateAcceptButton() {
        acceptButton.textContent = `Aceptar (${selectedItems.size} ingredientes)`;
        acceptButton.disabled = selectedItems.size === 0;
    }

    // ===============================================
    // L√ìGICA DE NAVEGACI√ìN HORIZONTAL (Scroll)
    // ===============================================
    
    function scrollGallery(direction) {
        const scrollAmount = magicBoxesGallery.clientWidth * 0.8; 
        
        if (direction === 1) {
            magicBoxesGallery.scrollLeft += scrollAmount;
        } else {
            magicBoxesGallery.scrollLeft -= scrollAmount;
        }
    }


    // ===============================================
    // L√ìGICA DE DISTRIBUCI√ìN DIN√ÅMICA DE INGREDIENTES FLOTANTES
    // ===============================================

    /**
     * Calcula y aplica la nueva posici√≥n (top, left) y el escalado (scale)
     * a todos los ingredientes flotantes seleccionados.
     */
    function updateFloatingArea() {
        const viewportWidth = window.innerWidth;
        const floatingElementsArray = Array.from(floatingElements.values());
        const totalItems = floatingElementsArray.length;
        
        // La zona de flotaci√≥n es ~90% del ancho de la pantalla
        const areaWidth = viewportWidth * 0.9; 
        const areaHeight = 150; // Definido en el HTML
        const areaTop = 150; // Definido en CSS variable --floating-area-top

        const maxItemSize = 1.0; 
        const minItemSize = 0.5;
        const baseItemWidth = 80; // Ancho visual estimado del elemento (60px burbuja + nombre)

        // Estrategia: Calcular el escalado y el espaciado para que todos quepan
        
        // 1. Calcular el tama√±o √≥ptimo de los √≠tems
        let scale = maxItemSize;
        let spacing = baseItemWidth;
        
        // Intentar que quepan 
        if (totalItems > 0) {
            const requiredWidth = totalItems * baseItemWidth;
            if (requiredWidth > areaWidth) {
                // Si no caben al 100%, calculamos el escalado necesario
                scale = Math.max(minItemSize, areaWidth / requiredWidth);
                spacing = baseItemWidth * scale;
            }
        }
        
        // 2. Calcular el desplazamiento inicial (para centrar la fila)
        const totalFloatingWidth = totalItems * spacing;
        const startX = (viewportWidth - totalFloatingWidth) / 2 + (spacing / 2) - 30; // -30 para centrar la burbuja (60/2)

        // 3. Aplicar posiciones a cada elemento
        floatingElementsArray.forEach((el, index) => {
            const targetLeft = startX + (index * spacing);
            const targetTop = areaTop + (areaHeight / 2) - 30 + Math.random() * 20 - 10; // Centrado en Y con jitter
            
            el.style.left = `${targetLeft}px`;
            el.style.top = `${targetTop}px`;
            el.style.transform = `scale(${scale})`; // Ajuste din√°mico de tama√±o

            // Si es la primera vez que se mueve a la zona, lo hacemos visible y animamos
            if (el.dataset.state !== 'floating') {
                el.style.opacity = '1';
                el.dataset.state = 'floating';
            }
        });
        
        // Mensaje de la zona de flotaci√≥n
        floatingAreaMessage.style.display = totalItems > 0 ? 'none' : 'block';
    }


    // ===============================================
    // L√ìGICA DE SELECCI√ìN M√ÅGICA
    // ===============================================

    function handleSelection(ingName) {
        const isSelected = selectedItems.has(ingName);
        const ingData = inventoryDetailsMap.get(ingName);
        
        if (!ingData) return;

        const boxSlot = document.querySelector(`.ing-slot[data-name="${ingName}"]`);
        
        if (isSelected) {
            // DESELECCIONAR: Aplicar animaci√≥n de ca√≠da/revent√≥n
            selectedItems.delete(ingName);
            removeFloatingElement(ingName);
            if (boxSlot) boxSlot.style.visibility = 'visible';
        } else {
            // SELECCIONAR: Aplicar animaci√≥n de flotar (creaci√≥n de burbuja)
            selectedItems.add(ingName);
            
            if (boxSlot) {
                boxSlot.style.visibility = 'hidden';
                // Creamos el elemento flotante, su posici√≥n inicial es sobre el slot.
                createFloatingElement(ingData, boxSlot); 
            }
        }
        
        saveSelectionToStorage();
        // Sincronizar el checkbox en la lista de compras
        const checklistCheckbox = document.querySelector(`#checklist-${ingName.replace(/\s/g, '_')}`);
        if (checklistCheckbox) checklistCheckbox.checked = selectedItems.has(ingName);
    }
    
    /**
     * Crea un ingrediente flotante con efecto de burbuja, posicionado inicialmente sobre su slot de caja.
     */
    function createFloatingElement(ingData, sourceElement) {
        if (floatingElements.has(ingData.nombre)) return;

        const targetSlot = document.querySelector(`.magic-box .ing-slot[data-name="${ingData.nombre}"]`);
        if (!targetSlot) return; 

        const rect = targetSlot.getBoundingClientRect();
        const galleryRect = magicBoxesGallery.getBoundingClientRect();
        
        const floatingEl = document.createElement('div');
        floatingEl.classList.add('floating-ingredient');
        floatingEl.setAttribute('data-name', ingData.nombre);
        floatingEl.dataset.state = 'initial'; // Estado inicial

        // Estructura con el wrapper de burbuja (ing-bubble)
        floatingEl.innerHTML = `
            <div class="ing-bubble-wrapper">
                <div class="ing-bubble">
                    <div class="ing-emoji">${ingData.emoji}</div>
                </div>
            </div>
            <div class="ing-name">${ingData.nombre}</div>
        `;

        document.body.appendChild(floatingEl);
        
        const bubbleSizeOffset = 30; // La burbuja mide 60px. Offset = 30px.

        // 1. Posici√≥n Inicial (Sobre el slot de la caja, abajo)
        const slotXInScrollContent = (rect.left - galleryRect.left) + magicBoxesGallery.scrollLeft;
        const offsetXFromSlotCenter = rect.width / 2 - bubbleSizeOffset; 
        const initialLeft = slotXInScrollContent + galleryRect.left + offsetXFromSlotCenter;
        const initialTop = rect.top + window.scrollY - bubbleSizeOffset; 
        
        floatingEl.style.left = `${initialLeft}px`;
        floatingEl.style.top = `${initialTop}px`; 

        // 2. Iniciar la animaci√≥n y moverlo a la zona de flotaci√≥n.
        requestAnimationFrame(() => {
            // Se hace visible y luego se llama a updateFloatingArea para reubicarlo.
            floatingEl.style.opacity = '1';
            updateFloatingArea(); 
        });

        floatingEl.addEventListener('click', () => {
            handleSelection(ingData.nombre);
        });

        floatingElements.set(ingData.nombre, floatingEl);
    }
    
    /**
     * Devuelve el ingrediente al slot con animaci√≥n de ca√≠da/revent√≥n de burbuja.
     */
    function removeFloatingElement(ingName) {
        const el = floatingElements.get(ingName);
        if (el) {
            // Aplicar el estado de animaci√≥n de ca√≠da (CSS falling)
            el.classList.add('falling');
            el.dataset.state = 'falling';
            
            // Eliminar despu√©s de que la animaci√≥n termine (500ms)
            setTimeout(() => {
                el.remove();
                floatingElements.delete(ingName);
                updateFloatingArea(); // Reubicar los restantes
            }, 500); 
        }
    }


    // ===============================================
    // RENDERIZADO Y UTILIDADES
    // ===============================================
    
    function groupIngredients(ingredients) {
        const groups = [];
        for (let i = 0; i < ingredients.length; i += 5) {
            groups.push(ingredients.slice(i, i + 5));
        }
        return groups;
    }

    function renderMagicBoxes() {
        magicBoxesGallery.innerHTML = '';
        
        // Limpiar elementos flotantes pre-existentes
        floatingElements.forEach(el => el.remove());
        floatingElements.clear();

        const ingredientGroups = groupIngredients(filteredInventory);
        
        ingredientGroups.forEach((group, index) => {
            const box = document.createElement('div');
            box.classList.add('magic-box');
            box.innerHTML = `<div class="box-title">Caja M√°gica ${index + 1}</div>`;
            
            group.forEach(ingData => {
                const isSelected = selectedItems.has(ingData.nombre);
                
                const slot = document.createElement('div');
                slot.classList.add('ing-slot');
                slot.setAttribute('data-name', ingData.nombre);
                slot.innerHTML = ingData.emoji;
                
                if (isSelected) {
                    slot.style.visibility = 'hidden';
                }
                
                slot.addEventListener('click', () => {
                    handleSelection(ingData.nombre);
                });
                
                box.appendChild(slot);
            });
            
            magicBoxesGallery.appendChild(box);
        });
        
        // Post-renderizado: Crear elementos flotantes que ya estaban seleccionados
        filteredInventory.forEach(ingData => {
            if (selectedItems.has(ingData.nombre)) {
                const sourceSlot = document.querySelector(`.ing-slot[data-name="${ingData.nombre}"]`);
                if (sourceSlot) {
                    // Crea el elemento flotante, luego updateFloatingArea lo mueve.
                    setTimeout(() => createFloatingElement(ingData, sourceSlot), 10); 
                }
            }
        });
        
        // Asegurar que la zona de flotaci√≥n se posicione correctamente
        setTimeout(updateFloatingArea, 100); 
    }

    function renderInitialList() {
        const listContainer = document.getElementById('initial-selection-list');
        listContainer.innerHTML = '';

        filteredInventory.forEach(ingData => {
            const isSelected = selectedItems.has(ingData.nombre);
            const item = document.createElement('div');
            item.classList.add('initial-item');
            
            item.innerHTML = `
                <input type="checkbox" id="checklist-${ingData.nombre.replace(/\s/g, '_')}" ${isSelected ? 'checked' : ''} data-name="${ingData.nombre}">
                <label for="checklist-${ingData.nombre.replace(/\s/g, '_')}">${ingData.emoji} ${ingData.nombre} (${ingData.cantidad_disponible || 'N/A'})</label>
            `;
            
            const checkbox = item.querySelector('input[type="checkbox"]');
            checkbox.addEventListener('change', () => {
                handleSelection(ingData.nombre); 
            });

            listContainer.appendChild(item);
        });
    }
    
    function toggleInitialList(action) {
        if (action === 'minimize') {
            initialListContainer.classList.add('minimized');
        } else {
            initialListContainer.classList.remove('minimized');
        }
    }
    
    // ===============================================
    // ANIMACI√ìN FINAL Y NAVEGACI√ìN
    // ===============================================

    async function handleFinalAnimation() {
        if (selectedItems.size === 0) return;
        
        acceptButton.disabled = true;
        const toggleListButton = document.getElementById('toggle-list-button');
        toggleListButton.disabled = true;

        const vortexContainer = document.getElementById('vortex-container');
        vortexContainer.style.display = 'flex';
        
        // Obtener la posici√≥n del v√≥rtice para el destino
        const vortexRect = vortexContainer.getBoundingClientRect();
        const centerVortexX = vortexRect.left + vortexRect.width / 2;
        const centerVortexY = vortexRect.top + vortexRect.height / 2;


        floatingElements.forEach((el) => {
            const rect = el.getBoundingClientRect();
            
            // Calcular la traslaci√≥n al centro del v√≥rtice
            // Se calcula el desplazamiento necesario desde la posici√≥n actual (ya movida a la zona de flotaci√≥n)
            const translateX = centerVortexX - (rect.left + rect.width / 2);
            const translateY = centerVortexY - (rect.top + rect.height / 2);
            
            // Aplicar la animaci√≥n de espiral y reducci√≥n (usando la nueva keyframe)
            el.style.transition = 'none'; // Desactivar transiciones de left/top/transform din√°micas
            el.style.animation = 'none'; // Desactivar animaci√≥n de levitaci√≥n sutil

            // Forzar la nueva posici√≥n base antes de iniciar la animaci√≥n CSS de espiral
            el.style.transformOrigin = 'center center'; 
            
            // Usamos la propiedad `transform` para la animaci√≥n combinada de traslaci√≥n, escala y rotaci√≥n
            el.style.transform = `
                translate(${translateX}px, ${translateY}px) 
                scale(0.01) 
                rotate(720deg)
            `;

            // Establecer la animaci√≥n de espiral (CSS)
            el.style.transition = 'transform 1.5s cubic-bezier(0.5, 0, 0.5, 1), opacity 1.5s'; 
            el.style.opacity = '1'; 
            
            // Desvanecer el ingrediente justo cuando la animaci√≥n termina (1.5s)
            setTimeout(() => {
                el.style.opacity = '0';
            }, 1000); 
        });

        await new Promise(resolve => setTimeout(resolve, 1500));
        
        floatingElements.forEach(el => el.remove());
        vortexContainer.style.display = 'none';

        saveSelectionToStorage();

        // Llamar a loadContent en el contexto padre para la navegaci√≥n
        if (window.parent && typeof window.parent.loadContent === 'function') {
            window.parent.loadContent('pantalla4.html');
        } else {
            window.loadContent('pantalla4.html');
        } 
    }
    
    // Escuchar el evento de redimensionamiento de la ventana para recalcular la posici√≥n de los flotantes
    window.addEventListener('resize', updateFloatingArea);


    // ===============================================
    // INICIALIZACI√ìN PRINCIPAL
    // ===============================================

    async function loadMenuData() {
        // (L√≥gica de carga de datos omitida por brevedad, se mantiene la original)
        try {
            loadingMessage.textContent = 'Buscando el grimorio de ingredientes en el almac√©n m√°gico...';
            
            let dataLoaded = null;

            if (window.parent && window.parent.inventarioData) {
                dataLoaded = window.parent.inventarioData;
                loadingMessage.textContent = '√âxito: Datos cargados directamente del padre.';
            }

            if (!dataLoaded) {
                 loadingMessage.textContent = 'El grimorio del padre no respondi√≥, intentando leer la copia local...';
                 const localData = localStorage.getItem('inventarioData');
                 if (localData) {
                    try {
                        dataLoaded = JSON.parse(localData);
                        loadingMessage.textContent = '√âxito: Datos cargados desde localStorage.';
                    } catch (e) {
                        console.error("Error al parsear inventarioData de localStorage:", e);
                    }
                 }
            }
            
            if (dataLoaded && Array.isArray(dataLoaded)) {
                filteredInventory = dataLoaded.filter(item => item.activo === true);
            } else {
                throw new Error("El inventarioData del grimorio no se pudo cargar o no est√° disponible.");
            }
            
            filteredInventory.forEach(item => {
                inventoryDetailsMap.set(item.nombre, item);
            });

            loadSelectionFromStorage();

            renderInitialList();
            
            setTimeout(() => {
                renderMagicBoxes();
                toggleInitialList('minimize'); 
                loadingMessage.textContent = '¬°Inventario cargado! Recolecta tus ingredientes.';
                updateAcceptButton();
            }, 50);


        } catch (error) {
            loadingMessage.style.color = '#f75555';
            loadingMessage.textContent = `ERROR M√ÅGICO: ${error.message}`;
            console.error("Fallo la carga de datos m√°gicos:", error);
        }
    }
    
    loadMenuData(); 
</script>
</body>
</html>
