<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>El Taller del Mago - Selecci√≥n de Ingredientes</title>
    
    <style>
        /* ======================================================================= */
        /* VARIABLES Y ESTILOS BASE (Tema Oscuro M√°gico) */
        /* ======================================================================= */
        :root {
            --bg-color: #0d1117;
            --text-color: #c9d1d9;
            --accent-color: #58a6ff; /* Azul m√°gico */
            --success-color: #238636;
            --box-bg-color: #161b22; /* Fondo de las cajas m√°gicas */
            --box-border-color: #30363d;
            --vortex-color: rgba(88, 166, 255, 0.8);
            --ingredient-lift: 50px; /* Distancia de levitaci√≥n */
        }
        
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 10px;
            text-align: center;
            font-size: 0.9em;
            overflow-x: hidden; /* Previene overflow por la animaci√≥n */
            position: relative; /* Para la animaci√≥n del v√≥rtice */
        }
        
        h2 {
            font-size: 1.6em;
            color: var(--accent-color);
            margin-bottom: 20px;
        }

        /* ------------------------------------------------------------------- */
        /* CONTENEDOR DE LISTA INICIAL (Checklist de Ingredientes) */
        /* ------------------------------------------------------------------- */
        #initial-selection-container {
            background-color: #1f242b;
            border: 1px solid var(--box-border-color);
            border-radius: 8px;
            margin-bottom: 20px;
            padding: 15px;
            transition: max-height 0.5s ease-in-out, opacity 0.3s;
        }
        
        #initial-selection-list {
            max-height: 400px;
            overflow-y: auto;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            padding-top: 10px;
            text-align: left;
        }
        
        .initial-item {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 5px;
            border-bottom: 1px dashed #30363d;
        }
        
        #minimize-button, #maximize-button {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
        }
        
        #minimize-button { background-color: #ffa500; color: #161b22; }
        #maximize-button { background-color: var(--accent-color); color: #161b22; }

        .minimized #initial-selection-list {
            max-height: 0;
            opacity: 0;
            padding: 0;
        }

        /* ------------------------------------------------------------------- */
        /* GALER√çA DE CAJAS M√ÅGICAS */
        /* ------------------------------------------------------------------- */
        #magic-boxes-gallery {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            padding: 20px 0;
        }
        
        .magic-box {
            width: 150px;
            height: 150px;
            background-color: var(--box-bg-color);
            border: 3px solid var(--box-border-color);
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
            position: relative;
            padding: 10px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 5px;
            transition: border-color 0.3s;
        }

        .box-title {
            position: absolute;
            top: -15px;
            background: var(--bg-color);
            padding: 0 8px;
            border-radius: 5px;
            font-size: 0.8em;
            color: #ffa500;
            font-weight: bold;
        }

        .ing-slot {
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5em;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        
        .ing-slot:hover {
            background-color: #30363d;
        }

        /* ------------------------------------------------------------------- */
        /* EFECTO FLOTANTE M√ÅGICO */
        /* ------------------------------------------------------------------- */
        .floating-ingredient {
            position: absolute; 
            z-index: 100;
            cursor: pointer;
            text-align: center;
            opacity: 1;
            /* La posici√≥n inicial se establece en JS */
            
            /* Transiciones de movimiento y opacidad */
            transition: transform 0.5s ease-in-out, opacity 0.5s, left 0s, top 0s;
            
            /* Animaci√≥n de levitaci√≥n sutil */
            animation: subtle-float 2s ease-in-out infinite alternate;
        }
        
        .floating-ingredient .ing-emoji {
            font-size: 2.5em;
            line-height: 1;
        }
        
        .floating-ingredient .ing-name {
            font-size: 0.7em;
            font-weight: 600;
            color: var(--text-color);
            text-shadow: 0 0 5px var(--accent-color); /* Toque m√°gico */
        }

        @keyframes subtle-float {
            from { transform: translateY(calc(var(--ingredient-lift) * -1)) scale(1.1); box-shadow: 0 0 15px rgba(88, 166, 255, 0.6); }
            to { transform: translateY(calc(var(--ingredient-lift) * -1.1)) scale(1.05); box-shadow: 0 0 8px rgba(88, 166, 255, 0.3); }
        }
        
        /* ------------------------------------------------------------------- */
        /* BOT√ìN DE ACCI√ìN Y V√ìRTICE FINAL */
        /* ------------------------------------------------------------------- */
        #accept-button {
            position: fixed;
            bottom: 20px;
            left: 20px;
            padding: 15px 25px;
            background-color: var(--success-color);
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            transition: background-color 0.3s;
            z-index: 200;
        }
        
        #accept-button:disabled {
            background-color: #30363d;
            cursor: not-allowed;
        }

        /* Contenedor de la animaci√≥n del v√≥rtice */
        #vortex-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 150;
            display: none;
            align-items: center;
            justify-content: center;
        }
        
        .vortex {
            width: 150px;
            height: 150px;
            background: radial-gradient(circle, rgba(0,0,0,0) 0%, var(--vortex-color) 70%, rgba(0,0,0,0) 100%);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* Animaci√≥n para los ingredientes al entrar al v√≥rtice */
        @keyframes vortex-pull {
            to {
                transform: translate(-50%, -50%) scale(0.1) rotate(720deg);
                opacity: 0;
            }
        }
        
    </style>
</head>
<body>

    <h2>El Taller del Mago: Recolecci√≥n de Ingredientes ‚ú®</h2>
    <div id="loading-message" style="color: var(--accent-color); margin-bottom: 20px;">Cargando inventario m√°gico...</div>

    <div id="initial-selection-container">
        <div id="initial-selection-list"> 
            </div>
        <button id="minimize-button" onclick="toggleInitialList('minimize')">Minimizar Lista</button>
        <button id="maximize-button" onclick="toggleInitialList('maximize')" style="display:none;">Traer Lista</button>
    </div>
    
    <div id="magic-boxes-gallery">
        </div>
    
    <div id="vortex-container">
        <div class="vortex"></div>
    </div>
    
    <button id="accept-button" onclick="handleFinalAnimation()" disabled>Aceptar (0 ingredientes)</button>


<script>
    // ===============================================
    // L√ìGICA DE LA APLICACI√ìN (Embedded JS)
    // ===============================================

    // CONSTANTES Y VARIABLES GLOBALES
    const loadingMessage = document.getElementById('loading-message');
    const initialListContainer = document.getElementById('initial-selection-container');
    const magicBoxesGallery = document.getElementById('magic-boxes-gallery');
    const acceptButton = document.getElementById('accept-button');

    // DATOS GLOBALES (Asumidos del contexto padre: main.js)
    let inventoryData = null;  // Objeto { inventario: [...] }
    let filteredInventory = []; // Inventario despu√©s de aplicar filtros
    let selectedItems = new Set(); // Nombres de ingredientes seleccionados
    let floatingElements = new Map(); // Mapa para rastrear los elementos flotantes: nombre -> DOM Element
    
    // Asumimos estas funciones de persistencia existen en el contexto padre o global
    if (typeof window.persistirInventario !== 'function') {
         window.persistirInventario = () => console.warn("DEBUG: Funci√≥n persistirInventario no definida.");
    }
    if (typeof window.cargarInventario !== 'function') {
         window.cargarInventario = async () => { 
             console.warn("DEBUG: Usando inventario mock.");
             // Mock de inventario si no se puede cargar del padre
             window.inventarioData = [
                { nombre: 'Pollo', emoji: 'üêî', categoria: 'principal', availability: 3 },
                { nombre: 'Arroz', emoji: 'üçö', categoria: 'carbohidratos', availability: 5 },
                { nombre: 'Br√≥coli', emoji: 'ü•¶', categoria: 'verduras', availability: 4 },
                { nombre: 'Salm√≥n', emoji: 'üêü', categoria: 'principal', availability: 2 },
                { nombre: 'Pasta', emoji: 'üçù', categoria: 'carbohidratos', availability: 3 },
                { nombre: 'Zanahoria', emoji: 'ü•ï', categoria: 'verduras', availability: 6 },
                { nombre: 'Pavo', emoji: 'ü¶É', categoria: 'principal', availability: 1 },
                { nombre: 'Quinoa', emoji: 'üåæ', categoria: 'carbohidratos', availability: 3 },
                { nombre: 'Tomate', emoji: 'üçÖ', categoria: 'verduras', availability: 5 },
                { nombre: 'Comod√≠n', emoji: '‚ú®', categoria: 'especial', availability: 1 },
             ];
         };
    }
    if (typeof window.loadContent !== 'function') {
         window.loadContent = (url) => console.log(`DEBUG: Navegando a ${url}`);
    }
    
    // Mapa auxiliar para obtener datos por nombre r√°pidamente
    let inventoryDetailsMap = new Map(); 

    // ===============================================
    // PERSISTENCIA LOCAL Y SINCRONIZACI√ìN DE ESTADO
    // ===============================================

    function saveSelectionToStorage() {
        const selectionData = {
            selectedItems: Array.from(selectedItems),
        };
        localStorage.setItem('magicIngredientSelection', JSON.stringify(selectionData));
        updateAcceptButton();
    }
    
    function loadSelectionFromStorage() {
        const localSelection = localStorage.getItem('magicIngredientSelection');
        if (localSelection) {
            const selection = JSON.parse(localSelection);
            selectedItems = new Set(selection.selectedItems);
        }
    }
    
    function updateAcceptButton() {
        acceptButton.textContent = `Aceptar (${selectedItems.size} ingredientes)`;
        acceptButton.disabled = selectedItems.size === 0;
    }

    // ===============================================
    // L√ìGICA DE SELECCI√ìN M√ÅGICA
    // ===============================================

    /**
     * Alterna la selecci√≥n de un ingrediente y aplica el efecto de levitaci√≥n/retorno.
     * @param {string} ingName - Nombre del ingrediente.
     * @param {HTMLElement} boxElement - Elemento de la caja de ingrediente (solo si se llama desde la caja).
     */
    function handleSelection(ingName, ingId, isChecklist = false) {
        const isSelected = selectedItems.has(ingName);
        const ingData = inventoryDetailsMap.get(ingName);
        
        if (!ingData) return;

        if (isSelected) {
            // DESELECCIONAR: Retornar a la caja
            selectedItems.delete(ingName);
            removeFloatingElement(ingName);
        } else {
            // SELECCIONAR: Aplicar levitaci√≥n
            selectedItems.add(ingName);
            
            // Si se selecciona desde la checklist, necesitamos encontrar su posici√≥n en la galer√≠a
            if (isChecklist) {
                // En la checklist, solo marcamos. La renderizaci√≥n de las cajas debe sincronizarse.
                // Por simplicidad, no creamos el elemento flotante aqu√≠, sino que actualizamos los checkboxes de la checklist.
                const checkbox = document.querySelector(`#checklist-${ingId}`);
                if (checkbox) checkbox.checked = true;
            } 
            
            // Si se selecciona desde la caja (o se sincroniza despu√©s de la checklist)
            // Necesitamos saber qu√© slot de la caja vamos a "vaciar" y usar para el elemento flotante.
            const boxSlot = document.querySelector(`.ing-slot[data-name="${ingName}"]`);
            if (boxSlot) {
                // Ocultar el slot original en la caja
                boxSlot.style.visibility = 'hidden'; 
                
                // Crear y levantar el elemento flotante
                createFloatingElement(ingData, boxSlot);
            }
        }
        
        saveSelectionToStorage();
        // Sincronizar el checkbox de la lista inicial
        const checklistCheckbox = document.querySelector(`#checklist-${ingName.replace(/\s/g, '_')}`);
        if (checklistCheckbox) checklistCheckbox.checked = selectedItems.has(ingName);
        
        // Si se deselecciona, reaparecer el slot en la caja
        if (!selectedItems.has(ingName)) {
            const boxSlot = document.querySelector(`.ing-slot[data-name="${ingName}"]`);
            if (boxSlot) boxSlot.style.visibility = 'visible';
        }
    }
    
    /**
     * Crea y posiciona el elemento flotante m√°gico.
     * @param {object} ingData - Objeto del ingrediente.
     * @param {HTMLElement} sourceElement - El elemento de origen (slot en la caja m√°gica).
     */
    function createFloatingElement(ingData, sourceElement) {
        // Si ya est√° flotando, no hacer nada (o manejar un doble click si fuera necesario)
        if (floatingElements.has(ingData.nombre)) return;

        // 1. Obtener la posici√≥n del slot de origen
        const rect = sourceElement.getBoundingClientRect();
        
        // 2. Crear el elemento flotante
        const floatingEl = document.createElement('div');
        floatingEl.classList.add('floating-ingredient');
        floatingEl.setAttribute('data-name', ingData.nombre);
        
        floatingEl.innerHTML = `
            <div class="ing-emoji">${ingData.emoji}</div>
            <div class="ing-name">${ingData.nombre}</div>
        `;

        // 3. Posicionamiento inicial: Se agrega al body y se posiciona exactamente sobre el slot
        document.body.appendChild(floatingEl);
        
        // Usamos requestAnimationFrame para asegurar que el elemento se ha a√±adido al DOM
        requestAnimationFrame(() => {
            // Posicionar con respecto a la ventana, sumando el scroll (si lo hubiera)
            floatingEl.style.left = `${rect.left + rect.width / 2 - floatingEl.offsetWidth / 2}px`;
            floatingEl.style.top = `${rect.top + window.scrollY}px`; 
            
            // 4. Aplicar la levitaci√≥n m√°gica despu√©s de una micro-pausa para la transici√≥n
            setTimeout(() => {
                 floatingEl.style.transform = `translateY(calc(var(--ingredient-lift) * -1)) scale(1.1)`;
            }, 50);
        });

        // 5. Agregar listener para deseleccionar (retornar a la caja)
        floatingEl.addEventListener('click', () => {
            handleSelection(ingData.nombre);
        });

        floatingElements.set(ingData.nombre, floatingEl);
    }
    
    // ===============================================
    // L√ìGICA DE RENDERIZADO
    // ===============================================
    
    /** Agrupa los ingredientes disponibles en grupos de 5. */
    function groupIngredients(ingredients) {
        const groups = [];
        for (let i = 0; i < ingredients.length; i += 5) {
            groups.push(ingredients.slice(i, i + 5));
        }
        return groups;
    }

    /** Renderiza la galer√≠a de cajas m√°gicas y los slots de ingredientes. */
    function renderMagicBoxes() {
        magicBoxesGallery.innerHTML = '';
        const ingredientGroups = groupIngredients(filteredInventory);
        
        ingredientGroups.forEach((group, index) => {
            const box = document.createElement('div');
            box.classList.add('magic-box');
            box.innerHTML = `<div class="box-title">Caja M√°gica ${index + 1}</div>`;
            
            group.forEach(ingData => {
                const isSelected = selectedItems.has(ingData.nombre);
                
                const slot = document.createElement('div');
                slot.classList.add('ing-slot');
                slot.setAttribute('data-name', ingData.nombre);
                slot.innerHTML = ingData.emoji;
                
                // Si est√° seleccionado, ocultar el slot e inmediatamente crear el elemento flotante
                if (isSelected) {
                    slot.style.visibility = 'hidden';
                    createFloatingElement(ingData, slot); // Asegura que el flotante se crea/recrea al cargar
                }
                
                // Listener para seleccionar (aplicar levitaci√≥n)
                slot.addEventListener('click', () => {
                    handleSelection(ingData.nombre); // Llama a la l√≥gica principal de selecci√≥n
                });
                
                box.appendChild(slot);
            });
            
            magicBoxesGallery.appendChild(box);
        });
    }

    /** Renderiza la lista inicial de ingredientes (checklist). */
    function renderInitialList() {
        const listContainer = document.getElementById('initial-selection-list');
        listContainer.innerHTML = '';

        filteredInventory.forEach(ingData => {
            const isSelected = selectedItems.has(ingData.nombre);
            const item = document.createElement('div');
            item.classList.add('initial-item');
            
            item.innerHTML = `
                <input type="checkbox" id="checklist-${ingData.nombre.replace(/\s/g, '_')}" ${isSelected ? 'checked' : ''} data-name="${ingData.nombre}">
                <label for="checklist-${ingData.nombre.replace(/\s/g, '_')}">${ingData.emoji} ${ingData.nombre} (${ingData.availability})</label>
            `;
            
            const checkbox = item.querySelector('input[type="checkbox"]');
            checkbox.addEventListener('change', (e) => {
                // Si se marca en la checklist, debe reflejarse en las cajas
                handleSelection(ingData.nombre, null, true); 
                
                // Forzar la re-renderizaci√≥n de las cajas flotantes despu√©s de un cambio en la checklist
                // Esta es una soluci√≥n simple para sincronizar las vistas.
                renderMagicBoxes();
            });

            listContainer.appendChild(item);
            
        });
    }
    
    /** Alterna la visibilidad de la lista inicial. */
    function toggleInitialList(action) {
        const minimizeBtn = document.getElementById('minimize-button');
        const maximizeBtn = document.getElementById('maximize-button');
        
        if (action === 'minimize') {
            initialListContainer.classList.add('minimized');
            minimizeBtn.style.display = 'none';
            maximizeBtn.style.display = 'block';
        } else {
            initialListContainer.classList.remove('minimized');
            minimizeBtn.style.display = 'block';
            maximizeBtn.style.display = 'none';
        }
    }
    
    // ===============================================
    // ANIMACI√ìN FINAL Y NAVEGACI√ìN
    // ===============================================

    /** Ejecuta la animaci√≥n de v√≥rtice y navega a pantalla 4. */
    async function handleFinalAnimation() {
        if (selectedItems.size === 0) return;
        
        acceptButton.disabled = true;

        // 1. Mostrar el contenedor del v√≥rtice en el centro
        const vortexContainer = document.getElementById('vortex-container');
        vortexContainer.style.display = 'flex';
        
        const centerVortexX = vortexContainer.offsetWidth / 2;
        const centerVortexY = vortexContainer.offsetHeight / 2;

        // 2. Aplicar la animaci√≥n a cada elemento flotante
        floatingElements.forEach((el, ingName) => {
            const rect = el.getBoundingClientRect();
            
            // Calcular la distancia a la que deben ser arrastrados
            const translateX = centerVortexX - rect.left - rect.width / 2;
            const translateY = centerVortexY - rect.top - rect.height / 2;
            
            // Establecer el origen de la transformaci√≥n al centro del v√≥rtice
            el.style.transition = 'transform 1.5s ease-in, opacity 1.5s';
            
            // Aplicar el movimiento espiral (combina el translate con la escala y rotaci√≥n de vortex-pull)
            el.style.transform = `
                translate(${translateX}px, ${translateY}px) 
                scale(0.1) 
                rotate(720deg)
            `;
            el.style.opacity = '0';
        });

        // 3. Esperar a que la animaci√≥n termine (1.5 segundos)
        await new Promise(resolve => setTimeout(resolve, 1500));
        
        // 4. Limpiar y navegar
        floatingElements.forEach(el => el.remove());
        floatingElements.clear();
        vortexContainer.style.display = 'none';

        // Guardamos la selecci√≥n final antes de navegar
        saveSelectionToStorage();

        // Navegar a la pantalla de planificaci√≥n
        window.loadContent('pantalla4.html'); 
    }

    // ===============================================
    // INICIALIZACI√ìN PRINCIPAL
    // ===============================================

    async function loadMenuData() {
        try {
            loadingMessage.textContent = 'Cargando inventario m√°gico desde el grimorio...';
            
            // 1. Cargar inventario del contexto padre (main.js)
            await window.cargarInventario();
            if (window.inventarioData) {
                inventoryData = { inventario: window.inventarioData };
            } else {
                throw new Error("El inventarioData del grimorio no se pudo cargar.");
            }

            // 2. Aplicar un filtrado b√°sico (asumimos que la Configuraci√≥n R√°pida ya lo hizo, aqu√≠ solo usamos los disponibles)
            // Para esta versi√≥n simple, usamos todo el inventario cargado.
            filteredInventory = inventoryData.inventario || [];
            
            // 3. Crear el mapa de detalles
            filteredInventory.forEach(item => {
                inventoryDetailsMap.set(item.nombre, item);
            });

            // 4. Cargar la selecci√≥n previa y sincronizar
            loadSelectionFromStorage();

            // 5. Renderizar las dos vistas
            renderInitialList();
            renderMagicBoxes();
            
            // 6. Configuraci√≥n final
            toggleInitialList('minimize'); // Empezamos minimizado
            loadingMessage.textContent = '¬°Inventario cargado! Haz magia con tus ingredientes.';
            updateAcceptButton();

        } catch (error) {
            loadingMessage.style.color = '#f75555';
            loadingMessage.textContent = `ERROR M√ÅGICO: ${error.message}`;
            console.error("Fallo la carga de datos m√°gicos:", error);
        }
    }
    
    // Retrasar la carga para asegurar que las funciones del padre (main.js) est√°n cargadas
    setTimeout(loadMenuData, 100); 
</script>
</body>
</html>
