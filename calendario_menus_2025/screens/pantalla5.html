<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>El Taller del Mago: Selección de Ingredientes</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" integrity="sha512-z3gLpd7yknf1YoNbCzqRKc4qyor8gaKU1qmn+CShxbuBusANI9QpRohGBreCFkKx3G3z3lE7B9f7K54z6W3CFA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <style>
        /* ======================================================================= */
        /* VARIABLES Y ESTILOS BASE (Tema Oscuro Mágico) */
        /* ======================================================================= */
        :root {
            --bg-color: #0d1117;
            --text-color: #c9d1d9;
            --accent-color: #58a6ff; /* Azul mágico */
            --success-color: #238636;
            --box-bg-color: #161b22; /* Fondo de las cajas mágicas */
            --box-border-color: #30363d;
            --vortex-color: rgba(88, 166, 255, 0.8);
            --ingredient-lift: 50px; /* Distancia de levitación */
            
            /* NUEVA ZONA DE FLOTACIÓN: Offset vertical */
            --floating-area-top: 300px; /* <--- EDICIÓN: Movido 30px más abajo (70px -> 100px) */
            --floating-area-height: 120px; 
        }
        
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* ======================================================================= */
        /* ESTILOS DE LA BARRA DE ACCIÓN SUPERIOR */
        /* ======================================================================= */
        #action-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: rgba(13, 17, 23, 0.95);
            padding: 10px 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            z-index: 10; 
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .action-button {
            background-color: var(--box-border-color);
            color: var(--text-color);
            border: 1px solid var(--accent-color);
            padding: 10px 15px;
            margin-right: 10px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s, transform 0.1s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .action-button:hover {
            background-color: var(--box-bg-color);
            transform: translateY(-1px);
        }

        .action-button:active {
            transform: translateY(0);
        }
        
        .action-button.success-action {
            background-color: var(--success-color);
            border-color: var(--success-color);
        }

        .action-button.success-action:hover {
            background-color: #2ea44f;
        }

        /* Contenedor de botones a la izquierda */
        #left-actions {
            display: flex;
            gap: 10px;
        }

        /* ======================================================================= */
        /* ESTILOS DEL CUERPO PRINCIPAL */
        /* ======================================================================= */
        #main-content {
            flex-grow: 1;
            padding-top: 60px; /* Espacio para la barra superior */
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            width: 100%;
            overflow-x: hidden;
        }

        h1 {
            color: var(--accent-color);
            font-size: 1.8em;
            margin-top: 20px;
            margin-bottom: 5px;
        }
        
        #message-area {
            color: var(--text-color);
            margin-bottom: 20px;
            min-height: 20px;
        }

        /* ======================================================================= */
        /* ESTILOS DE LA ZONA DE SELECCIÓN (LEVISTACIÓN) */
        /* ======================================================================= */
        #selection-area {
            width: 90%;
            max-width: 900px;
            min-height: var(--floating-area-height);
            margin: 20px auto 10px auto;
            border: 3px dashed var(--vortex-color);
            border-radius: 15px;
            position: relative;
            background-color: rgba(22, 27, 34, 0.4); /* Un poco de fondo */
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            padding: 10px;
        }

        #selection-area:before {
            content: "Zona de Levistación: Arrastra aquí tus ingredientes seleccionados (Máximo 5)";
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            color: var(--vortex-color);
            font-size: 0.8em;
            font-style: italic;
        }

        .selected-item {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            margin: 5px;
            padding: 5px 10px;
            background-color: var(--box-bg-color);
            border: 1px solid var(--accent-color);
            border-radius: 8px;
            cursor: move; /* Indica que es arrastrable */
            box-shadow: 0 0 10px rgba(88, 166, 255, 0.5);
            transition: transform 0.2s;
        }

        .selected-item span {
            font-size: 0.9em;
        }
        
        .selected-item .quantity {
            font-weight: bold;
            color: var(--success-color);
        }

        /* ======================================================================= */
        /* ESTILOS DE INVENTARIO (Listado de Ingredientes) */
        /* ======================================================================= */
        #inventory-container {
            width: 90%;
            max-width: 1000px;
            margin: 20px auto;
            padding: 15px;
            background-color: var(--box-bg-color);
            border: 1px solid var(--box-border-color);
            border-radius: 10px;
        }
        
        #inventory-container h2 {
            color: var(--text-color);
            margin-top: 0;
            border-bottom: 1px solid var(--box-border-color);
            padding-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #toggle-list-button {
            background: none;
            border: none;
            color: var(--accent-color);
            cursor: pointer;
            font-size: 1.2em;
            transition: transform 0.2s;
        }

        #inventory-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 10px 0;
            transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out;
            max-height: 500px; /* Altura máxima por defecto */
            overflow: hidden;
            opacity: 1;
        }
        
        .inventory-item {
            background-color: #2b313a;
            border: 1px solid var(--box-border-color);
            border-radius: 6px;
            padding: 8px 12px;
            cursor: grab;
            transition: background-color 0.1s, transform 0.1s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .inventory-item:hover {
            background-color: #363c46;
            border-color: var(--accent-color);
        }

        .inventory-item:active {
            cursor: grabbing;
        }

        /* Estado minimizado */
        #inventory-list.minimized {
            max-height: 0;
            opacity: 0;
            padding-top: 0;
            padding-bottom: 0;
            pointer-events: none;
        }

        /* ======================================================================= */
        /* ESTILOS DE LAS CAJAS MÁGICAS (Vistas alternativas del inventario) */
        /* ======================================================================= */
        #magic-boxes-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
            width: 90%;
            max-width: 1200px;
            margin: 20px auto;
            padding: 15px;
            min-height: 300px;
        }

        .magic-box {
            width: 150px;
            height: 150px;
            background-color: var(--box-bg-color);
            border: 2px solid var(--box-border-color);
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
            transition: border-color 0.2s, box-shadow 0.2s;
            position: relative;
            cursor: pointer;
            overflow: hidden;
        }

        .magic-box.selected {
            border-color: var(--accent-color);
            box-shadow: 0 0 25px var(--accent-color);
        }
        
        .magic-box-icon {
            font-size: 3em;
            color: var(--text-color);
            margin-bottom: 5px;
            pointer-events: none; /* Ignorar clicks para que solo el box responda */
        }
        
        .magic-box-name {
            font-weight: bold;
            font-size: 0.9em;
            color: var(--accent-color);
            pointer-events: none;
        }

        .magic-box-quantity {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: var(--success-color);
            color: white;
            border-radius: 50%;
            padding: 2px 7px;
            font-size: 0.7em;
            pointer-events: none;
        }

        /* ======================================================================= */
        /* NUEVOS ESTILOS PARA POPUP DE RECETAS (COPIADO DE PANTALLA7) */
        /* ======================================================================= */

        :root {
            /* Se añaden variables necesarias si no existían (se asume que sí, pero se redefinen para claridad si no estaban) */
            --selection-color: #58a6ff; 
            --card-bg-color: #2b313a; 
            --card-border-color: #484f58;
        }

        /* --- POPUP (MODAL) BASE STYLE --- */
        #recipe-popup {
            display: none; /* Hidden by default */
            position: fixed;
            z-index: 1000; 
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.9); /* Oscurece el fondo */
            backdrop-filter: blur(5px);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: var(--box-bg-color);
            margin: 5% auto; /* 5% desde arriba y centrado */
            padding: 20px;
            border: 2px solid var(--accent-color);
            width: 80%; /* Ancho apropiado */
            max-width: 700px;
            border-radius: 10px;
            box-shadow: 0 0 30px var(--accent-color);
            text-align: center;
            transform: scale(0.95);
            transition: transform 0.3s ease-out;
        }

        #recipe-popup.visible .modal-content {
            transform: scale(1);
        }

        .modal-content h2 {
            color: var(--selection-color);
            border-bottom: 2px solid var(--card-border-color);
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        #recipes-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
        }

        /* --- ESTILO DE TARJETA DE RECETA --- */
        .recipe-card {
            background-color: var(--card-bg-color);
            border: 1px solid var(--card-border-color);
            border-radius: 8px;
            padding: 15px;
            text-align: left;
            transition: transform 0.2s;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
        }

        .recipe-card:hover {
            transform: translateY(-3px);
            border-color: var(--selection-color);
        }

        .recipe-card h3 {
            margin-top: 0;
            color: var(--accent-color);
            font-size: 1.2em;
            border-bottom: 1px dashed var(--card-border-color);
            padding-bottom: 5px;
            margin-bottom: 10px;
        }

        .recipe-ingredients {
            margin-bottom: 15px;
        }

        .recipe-ingredients p {
            margin: 5px 0;
            font-size: 0.9em;
        }

        .ingredient-name {
            font-weight: bold;
            color: var(--text-color);
        }

        .ingredient-quantity {
            color: var(--success-color);
            font-style: italic;
        }

        .recipe-action-button {
            background-color: var(--success-color);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .recipe-action-button:hover {
            background-color: #38a848;
        }

        /* ======================================================================= */
        /* MEDIA QUERIES */
        /* ======================================================================= */
        @media (max-width: 600px) {
            #action-bar {
                flex-direction: column;
                padding: 10px;
            }

            #left-actions {
                margin-top: 10px;
            }
            
            .action-button {
                margin-right: 0;
                width: 100%;
                justify-content: center;
            }
            
            #main-content {
                padding-top: 120px; /* Ajuste para la barra vertical */
            }

            .modal-content {
                width: 95%;
                margin: 10% auto;
            }
        }
    </style>
</head>
<body>
    
    <div id="action-bar">
        <div id="left-actions">
            <button id="go-to-pantalla2-button" class="action-button">
                <i class="fas fa-arrow-left"></i> Volver a Grimorio
            </button>
            
            <button id="show-recipes-button" class="action-button">
                <i class="fas fa-scroll"></i> Receta
            </button>
            </div>
        
        <button id="accept-selection-button" class="action-button success-action" disabled>
            <i class="fas fa-arrow-right"></i> Aceptar Selección (0/5)
        </button>
    </div>

    <div id="main-content">
        <h1>Selección de Ingredientes para la Pócima</h1>
        <p id="message-area">Cargando datos mágicos...</p>
        
        <div id="selection-area">
            </div>
        
        <div id="inventory-container">
            <h2>
                Inventario de Ingredientes 
                <button id="toggle-list-button" title="Alternar Vista">
                    <i class="fas fa-expand"></i>
                </button>
            </h2>
            
            <div id="inventory-list">
                </div>
            
            <div id="magic-boxes-container">
                </div>
        </div>
    </div>
    
    <div id="recipe-popup" class="modal-backdrop">
        <div class="modal-content">
            <h2><i class="fas fa-scroll"></i> Grimorio de Recetas</h2>
            <div id="recipes-list">
                </div>
            <button id="close-recipes-button" class="action-button">Cerrar</button>
        </div>
    </div>
    <script>
        
        // =======================================================================
        // DATA Y CONFIGURACIÓN
        // =======================================================================
        const MAX_INGREDIENTS = 5;
        let filteredInventory = [];
        const inventoryDetailsMap = new Map();
        let selectedIngredients = new Map(); // Mapa para {nombre: {element}}

        // INICIO: Data de Recetas añadido
        const recipes = [
            { nombre: "Jugo de Manzana Revitalizante", ingredientes: [{ nombre: "Manzana", cantidad: 3 }, { nombre: "Agua de Manantial", cantidad: 1 }] },
            { nombre: "Elixir de Fuerza Arcana", ingredientes: [{ nombre: "Raíz de Mandrágora", cantidad: 1 }, { nombre: "Savia Lunar", cantidad: 2 }, { nombre: "Esencia de Sol", cantidad: 1 }] },
            { nombre: "Tónico de Invisibilidad", ingredientes: [{ nombre: "Pelo de Troll", cantidad: 5 }, { nombre: "Ojo de Salamandra", cantidad: 1 }] },
            { nombre: "Pastel de Luna Llena", ingredientes: [{ nombre: "Harina Élfica", cantidad: 2 }, { nombre: "Miel de Abeja Gigante", cantidad: 3 }, { nombre: "Vapor de Nube", cantidad: 1 }] },
            { nombre: "Brevemente Aliento de Dragón", ingredientes: [{ nombre: "Polvo de Estrellas", cantidad: 4 }, { nombre: "Piel de Serpiente", cantidad: 1 }, { nombre: "Huevo de Grifo", cantidad: 2 }] }
        ];
        // FIN: Data de Recetas añadido

        // =======================================================================
        // ELEMENTOS DEL DOM
        // =======================================================================
        const selectionArea = document.getElementById('selection-area');
        const inventoryList = document.getElementById('inventory-list');
        const magicBoxesContainer = document.getElementById('magic-boxes-container');
        const loadingMessage = document.getElementById('message-area');
        const acceptButton = document.getElementById('accept-selection-button');
        const goToPantalla2Button = document.getElementById('go-to-pantalla2-button');
        const toggleListButton = document.getElementById('toggle-list-button');
        
        // INICIO: Elementos del DOM de Recetas añadido
        const recipePopup = document.getElementById('recipe-popup');
        const recipesList = document.getElementById('recipes-list');
        const showRecipesButton = document.getElementById('show-recipes-button');
        const closeRecipesButton = document.getElementById('close-recipes-button');
        // FIN: Elementos del DOM de Recetas añadido


        // =======================================================================
        // FUNCIONES DE UTILIDAD Y CORE (ORIGINALES)
        // =======================================================================
        
        function updateAcceptButton() {
            const currentCount = selectedIngredients.size;
            acceptButton.textContent = `Aceptar Selección (${currentCount}/${MAX_INGREDIENTS})`;
            acceptButton.disabled = currentCount === 0;
            
            if (currentCount > 0) {
                acceptButton.classList.add('success-action');
            } else {
                acceptButton.classList.remove('success-action');
            }
        }
        
        function showMessage(text, type = 'default') {
            // Asegurando que la variable CSS se resuelva correctamente
            const successColor = getComputedStyle(document.documentElement).getPropertyValue('--success-color').trim();
            const textColor = getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim();

            loadingMessage.textContent = text;
            loadingMessage.style.color = type === 'error' ? '#f75555' : type === 'success' ? successColor : textColor;
        }

        // =======================================================================
        // LÓGICA DE DRAG AND DROP / SELECCIÓN (ORIGINAL)
        // =======================================================================

        function handleItemClick(event) {
            let itemName = event.currentTarget.dataset.name;
            let detail = inventoryDetailsMap.get(itemName);
            
            if (detail.cantidad <= 0) {
                showMessage(`ERROR: No quedan existencias de ${itemName}.`, 'error');
                return;
            }

            if (selectedIngredients.size >= MAX_INGREDIENTS) {
                if (!selectedIngredients.has(itemName)) {
                    showMessage(`ERROR: Ya has alcanzado el límite de ${MAX_INGREDIENTS} ingredientes.`, 'error');
                    return;
                }
            }

            if (selectedIngredients.has(itemName)) {
                // Eliminar el ingrediente (si ya estaba)
                removeItemFromSelection(itemName);
            } else {
                // Añadir el ingrediente
                addItemToSelection(itemName);
            }

            // Actualizar la cantidad en el inventario visual
            detail.cantidad--;
            
            // Renderiza ambas vistas para reflejar la cantidad restante y el estado de selección
            renderMagicBoxes();
            renderInitialList();
            
            updateAcceptButton();
            saveSelectionToStorage();
        }

        function addItemToSelection(name) {
            if (!selectedIngredients.has(name)) {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'selected-item';
                itemDiv.dataset.name = name;
                
                const icon = inventoryDetailsMap.get(name).icono;
                itemDiv.innerHTML = `<i class="${icon}"></i> <span>${name}</span>`;
                
                // Agregar event listener para poder eliminar al hacer click
                itemDiv.addEventListener('click', () => {
                    removeItemFromSelection(name);
                    
                    // Actualizar la cantidad en el inventario visual
                    let detail = inventoryDetailsMap.get(name);
                    detail.cantidad++;
                    renderMagicBoxes();
                    renderInitialList();
                    
                    updateAcceptButton();
                    saveSelectionToStorage();
                });

                selectionArea.appendChild(itemDiv);
                selectedIngredients.set(name, { element: itemDiv });
                
                showMessage(`Ingrediente ${name} añadido a la selección.`, 'default');
            }
        }

        function removeItemFromSelection(name) {
            const item = selectedIngredients.get(name);
            if (item) {
                selectionArea.removeChild(item.element);
                selectedIngredients.delete(name);
                showMessage(`Ingrediente ${name} removido de la selección.`, 'default');
            }
        }

        // =======================================================================
        // LÓGICA DE RENDERIZADO (ORIGINAL)
        // =======================================================================

        function renderInitialList() {
            inventoryList.innerHTML = '';
            filteredInventory.forEach(item => {
                if (item.activo) {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = `inventory-item ${item.cantidad === 0 ? 'disabled' : ''}`;
                    itemDiv.dataset.name = item.nombre;
                    itemDiv.innerHTML = `<i class="${item.icono}"></i> ${item.nombre} <span style="color:var(--accent-color);">(${item.cantidad})</span>`;
                    itemDiv.addEventListener('click', handleItemClick);
                    inventoryList.appendChild(itemDiv);
                }
            });
        }
        
        function renderMagicBoxes() {
            magicBoxesContainer.innerHTML = '';
            filteredInventory.forEach(item => {
                if (item.activo) {
                    const box = document.createElement('div');
                    box.className = `magic-box ${selectedIngredients.has(item.nombre) ? 'selected' : ''}`;
                    box.dataset.name = item.nombre;
                    box.title = item.nombre;
                    
                    box.innerHTML = `
                        <i class="${item.icono} magic-box-icon"></i>
                        <span class="magic-box-name">${item.nombre}</span>
                        <span class="magic-box-quantity">${item.cantidad}</span>
                    `;
                    
                    // Agregar event listener a la caja
                    box.addEventListener('click', handleItemClick);
                    
                    magicBoxesContainer.appendChild(box);
                }
            });
        }
        
        function toggleInitialList(forceState = null) {
            if (forceState === 'minimize') {
                inventoryList.classList.add('minimized');
                magicBoxesContainer.style.display = 'flex';
                toggleListButton.innerHTML = '<i class="fas fa-search-plus"></i>';
                toggleListButton.title = 'Mostrar Inventario Completo';
            } else if (forceState === 'expand') {
                inventoryList.classList.remove('minimized');
                magicBoxesContainer.style.display = 'none';
                toggleListButton.innerHTML = '<i class="fas fa-search-minus"></i>';
                toggleListButton.title = 'Ocultar Inventario Completo';
            } else { // Toggle
                const isMinimized = inventoryList.classList.toggle('minimized');
                magicBoxesContainer.style.display = isMinimized ? 'flex' : 'none';
                toggleListButton.innerHTML = isMinimized ? '<i class="fas fa-search-plus"></i>' : '<i class="fas fa-search-minus"></i>';
                toggleListButton.title = isMinimized ? 'Mostrar Inventario Completo' : 'Ocultar Inventario Completo';
            }
        }

        // =======================================================================
        // LÓGICA DE ALMACENAMIENTO LOCAL (ORIGINAL)
        // =======================================================================

        function saveSelectionToStorage() {
            const selectionArray = Array.from(selectedIngredients.keys());
            localStorage.setItem('pantalla5Selection', JSON.stringify(selectionArray));
        }

        function loadSelectionFromStorage() {
            const savedSelection = localStorage.getItem('pantalla5Selection');
            if (savedSelection) {
                try {
                    const selectionArray = JSON.parse(savedSelection);
                    
                    // Limpiar selección actual antes de cargar
                    selectedIngredients.clear();
                    selectionArea.innerHTML = '';
                    
                    // Asegurar que las cantidades en filteredInventory se reinicien o estén correctas
                    // La lógica para esto asume que 'filteredInventory' ya fue cargado por loadMenuData()
                    
                    // Cargar la selección guardada
                    selectionArray.forEach(name => {
                        const detail = inventoryDetailsMap.get(name);
                        if (detail && detail.cantidad > 0) {
                            // Usar directamente la función interna para evitar recursión de renderizado.
                            const itemDiv = document.createElement('div');
                            itemDiv.className = 'selected-item';
                            itemDiv.dataset.name = name;
                            
                            const icon = inventoryDetailsMap.get(name).icono;
                            itemDiv.innerHTML = `<i class="${icon}"></i> <span>${name}</span>`;
                            
                            // Agregar event listener para poder eliminar al hacer click
                            itemDiv.addEventListener('click', () => {
                                removeItemFromSelection(name);
                                
                                let detail = inventoryDetailsMap.get(name);
                                detail.cantidad++;
                                renderMagicBoxes();
                                renderInitialList();
                                
                                updateAcceptButton();
                                saveSelectionToStorage();
                            });

                            selectionArea.appendChild(itemDiv);
                            selectedIngredients.set(name, { element: itemDiv });
                            
                            detail.cantidad--; // Restar del inventario

                        }
                    });
                } catch (e) {
                    console.error("Error al parsear pantalla5Selection de localStorage:", e);
                }
            }
        }
        
        // =======================================================================
        // INICIO: LÓGICA DE RECETAS (AÑADIDA)
        // =======================================================================
        
        function renderRecipes() {
            recipesList.innerHTML = ''; // Limpiar lista
            recipes.forEach((recipe) => {
                const card = document.createElement('div');
                card.className = 'recipe-card';

                const title = document.createElement('h3');
                title.textContent = recipe.nombre;
                card.appendChild(title);

                const ingredientsDiv = document.createElement('div');
                ingredientsDiv.className = 'recipe-ingredients';

                recipe.ingredientes.forEach(ing => {
                    const p = document.createElement('p');
                    p.innerHTML = `<span class="ingredient-name">${ing.nombre}</span>: <span class="ingredient-quantity">${ing.cantidad}</span> unidad(es)`;
                    ingredientsDiv.appendChild(p);
                });
                card.appendChild(ingredientsDiv);
                
                // Botón de acción (para seleccionar la receta)
                const actionButton = document.createElement('button');
                actionButton.className = 'recipe-action-button';
                actionButton.textContent = 'Seleccionar Receta';
                // Usamos un closure para pasar el objeto 'recipe' a la función
                actionButton.onclick = () => selectRecipe(recipe); 
                card.appendChild(actionButton);


                recipesList.appendChild(card);
            });
        }

        function showRecipesPopup() {
            renderRecipes(); // Renderizar las recetas antes de mostrar
            recipePopup.classList.add('visible');
            recipePopup.style.display = 'flex';
        }

        function hideRecipesPopup() {
            recipePopup.classList.remove('visible');
            // Usamos un pequeño delay para que la transición de CSS se vea
            setTimeout(() => {
                if (!recipePopup.classList.contains('visible')) {
                    recipePopup.style.display = 'none';
                }
            }, 300); 
        }

        // Función de Placeholder para la acción del botón de Receta
        function selectRecipe(recipe) {
            alert(`¡Receta seleccionada: ${recipe.nombre}! Esta función debería cargar los ingredientes en la zona de selección, pero requiere lógica de inventario no solicitada.`);
            // Lógica pendiente:
            // 1. Limpiar selección actual (selectedIngredients.clear() y selectionArea.innerHTML = '').
            // 2. Iterar sobre recipe.ingredientes y llamar a addItemToSelection(ing.nombre) la cantidad de veces que sea necesario.
            // 3. Verificar que haya existencias en inventoryDetailsMap antes de seleccionar.
            hideRecipesPopup();
            // Volver a renderizar todo
            // renderMagicBoxes();
            // renderInitialList();
            // updateAcceptButton();
            // saveSelectionToStorage();
        }
        // FIN: LÓGICA DE RECETAS (AÑADIDA)
        
        // =======================================================================
        // INICIALIZACIÓN (ORIGINAL)
        // =======================================================================

        document.addEventListener('DOMContentLoaded', () => {
            
            // 1. Manejo del botón de Volver
            goToPantalla2Button.addEventListener('click', () => {
                // Guarda la selección antes de salir
                saveSelectionToStorage();
                
                // ASUNCIÓN: Se utiliza una función global 'loadScreen' para el cambio de pantalla.
                if (window.parent && typeof window.parent.loadScreen === 'function') {
                    window.parent.loadScreen('pantalla2');
                } else if (typeof window.loadScreen === 'function') {
                    window.loadScreen('pantalla2');
                } else {
                    console.warn("La función loadScreen('pantalla2') no está definida.");
                }
            });
            
            // 2. Manejo del botón de Aceptar
            acceptButton.addEventListener('click', () => {
                if (selectedIngredients.size > 0) {
                    const selectedNames = Array.from(selectedIngredients.keys());
                    localStorage.setItem('ingredientesSeleccionados', JSON.stringify(selectedNames));
                    showMessage(`¡Selección de ${selectedNames.length} ingredientes guardada! Procediendo al siguiente paso.`, 'success');

                    // ASUNCIÓN: Ir a pantalla 6 (por ejemplo)
                    if (window.parent && typeof window.parent.loadScreen === 'function') {
                        window.parent.loadScreen('pantalla6');
                    } else if (typeof window.loadScreen === 'function') {
                        window.loadScreen('pantalla6');
                    } else {
                        console.warn("La función loadScreen('pantalla6') no está definida.");
                    }

                } else {
                    showMessage("Por favor, selecciona al menos un ingrediente.", 'error');
                }
            });

            // 3. Manejo del botón de alternar vista
            toggleListButton.addEventListener('click', () => {
                toggleInitialList();
            });
            
            // 4. LISTENERS PARA RECETAS (AÑADIDO)
            showRecipesButton.addEventListener('click', showRecipesPopup);
            closeRecipesButton.addEventListener('click', hideRecipesPopup);

            // Listener para cerrar el modal al hacer click fuera de él
            window.addEventListener('click', (event) => {
                if (event.target === recipePopup) { hideRecipesPopup(); }
            });
            // FIN: LISTENERS PARA RECETAS (AÑADIDO)

            // 5. Carga de datos de inventario e inicialización de vistas
            loadMenuData();
        });

        // Función de Carga de datos simulada (ORIGINAL)
        async function loadMenuData() {
            let dataLoaded = null;
            
            try {
                const GRIMORIO_DATA_KEY = 'inventarioData';
                
                // ASUNCIÓN: Carga de datos desde localStorage (simulando la carga de pantalla2/grimorio)
                const localData = localStorage.getItem(GRIMORIO_DATA_KEY);
                 if (localData) {
                    try {
                        dataLoaded = JSON.parse(localData);
                        loadingMessage.textContent = 'Éxito: Datos cargados desde localStorage.';
                    } catch (e) {
                        console.error("Error al parsear inventarioData de localStorage:", e);
                    }
                 }
            
            
            if (dataLoaded && Array.isArray(dataLoaded)) {
                filteredInventory = dataLoaded.filter(item => item.activo === true);
            } else {
                throw new Error("El inventarioData del grimorio no se pudo cargar o no está disponible.");
            }
            
            filteredInventory.forEach(item => {
                inventoryDetailsMap.set(item.nombre, item);
            });

            loadSelectionFromStorage();

            renderInitialList();
            
            setTimeout(() => {
                renderMagicBoxes();
                toggleInitialList('minimize'); 
                loadingMessage.textContent = '¡Inventario cargado! Recolecta tus ingredientes.';
                updateAcceptButton();
            }, 50);


            } catch (error) {
                loadingMessage.style.color = '#f75555';
                loadingMessage.textContent = `ERROR MÁGICO: ${error.message}`;
                console.error("Fallo la carga de datos mágicos:", error);
            }
        }
        
    </script>
</body>
</html>
